# SPIRE Agent Configuration for x0tta6bl4 Mesh Nodes
# Template: ansible/templates/spire-agent.conf.j2
# Generated by: bulk_flash.yml

agent {
    # Data directory for SPIRE agent
    data_dir = "/var/lib/spire/agent"
    
    # Log level (can be overridden via inventory)
    log_level = "{{ spire_log_level | default('INFO') }}"
    
    # Server address (from inventory or default)
    server_address = "{{ spire_server | default('spire-server.x0tta6bl4.mesh') }}"
    server_port = {{ spire_server_port | default(8081) }}
    
    # Socket path for workload API
    socket_path = "/run/spire/sockets/agent.sock"
    
    # Trust domain
    trust_domain = "{{ spire_trust_domain | default('x0tta6bl4.mesh') }}"
}

plugins {
    # KeyManager - uses disk for key storage
    KeyManager "disk" {
        plugin_data {
            directory = "/var/lib/spire/agent/keys"
        }
    }
    
    # NodeAttestor - join token based attestation
    NodeAttestor "join_token" {
        plugin_data {
            # Join token will be provided via environment
            # SPIRE_AGENT_JOIN_TOKEN=<token>
        }
    }
    
    # WorkloadAttestor - Unix based workload identification
    WorkloadAttestor "unix" {
        plugin_data {
            # Discover workloads by their Unix process ID
        }
    }
    
    # WorkloadAttestor - Docker container identification
    WorkloadAttestor "docker" {
        plugin_data {
            # Docker socket for container discovery
            docker_socket = "/var/run/docker.sock"
        }
    }
}

# Health check configuration
health_checks {
    listener_enabled = true
    bind_address = "0.0.0.0"
    bind_port = {{ spire_agent_health_port | default(8082) }}
    
    # Live path returns 200 if agent is healthy
    live_path = "/live"
    
    # Ready path returns 200 if agent is ready to serve
    ready_path = "/ready"
}
