#!/bin/bash
# vault-migration.sh
# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ Vault.

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

log_info() { echo -e "${GREEN}[INFO] $1${NC}"; }
log_warn() { echo -e "${YELLOW}[WARN] $1${NC}"; }
log_error() { echo -e "${RED}[ERROR] $1${NC}"; exit 1; }

log_info "üöÄ –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ Vault."

# --- 1. –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã ---
log_info "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞ –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ git-secrets
if ! command -v git-secrets &> /dev/null; then
    log_warn "git-secrets –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –¥–ª—è –±–æ–ª–µ–µ –ø–æ–ª–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: brew install git-secrets / sudo apt-get install git-secrets"
    log_warn "–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å grep-—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º..."
fi

if command -v git-secrets &> /dev/null; then
    log_info "–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é git secrets --scan..."
    if ! git secrets --scan; then
        log_warn "git secrets –æ–±–Ω–∞—Ä—É–∂–∏–ª –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã. –ü—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤—ã–≤–æ–¥ –≤—ã—à–µ."
    else
        log_info "git secrets –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤."
    fi
else
    log_warn "git-secrets –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è."
fi

# –ü–æ–∏—Å–∫ hardcoded –∑–Ω–∞—á–µ–Ω–∏–π –≤ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö —Å grep
log_info "–ü–æ–∏—Å–∫ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤ —Å –ø–æ–º–æ—â—å—é grep..."
HARDCODED_SECRETS=$(grep -rnE "password|secret|key|token" deployment/ scripts/ infra/kubernetes/ 2>/dev/null || true)

if [ -n "$HARDCODED_SECRETS" ]; then
    log_warn "grep –æ–±–Ω–∞—Ä—É–∂–∏–ª –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö/—Å—Ç—Ä–æ–∫–∞—Ö:"
    echo "$HARDCODED_SECRETS"
    log_warn "–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—Ä—É—á–Ω—É—é –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ Vault."
else
    log_info "grep –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª –æ—á–µ–≤–∏–¥–Ω—ã—Ö –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è—Ö."
fi

# --- 2. –ú–∏–≥—Ä–∞—Ü–∏—è –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ Vault ---
log_info "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ Vault (—Ä—É—á–Ω–æ–π –∏–ª–∏ –ø–æ–ª—É–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —à–∞–≥)..."
log_warn "–≠—Ç–æ –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–π —à–∞–≥. –í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —Å –ø–æ–º–æ—â—å—é —Å–∫—Ä–∏–ø—Ç–∞-–ø–æ–º–æ—â–Ω–∏–∫–∞"
log_warn "–¥–æ–±–∞–≤–∏—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ Vault. –ù–∞–ø—Ä–∏–º–µ—Ä:"
log_warn "  vault kv put secret/x0tta6bl4/deploy/mesh NODE1_ROOT_PASSWORD='<root_password_for_node1>' NODE2_ROOT_PASSWORD='<root_password_for_node2>'"
log_warn "  vault kv put secret/x0tta6bl4/monitoring GRAFANA_ADMIN_PASSWORD='<grafana_admin_password>'"
log_warn "  vault kv put secret/x0tta6bl4/minio MINIO_ACCESS_KEY='<access_key>' MINIO_SECRET_KEY='<secret_key>'"
log_warn "  vault kv put secret/x0tta6bl4/postgres POSTGRES_PASSWORD='<postgres_password>'"

# --- 3. –ó–∞–º–µ–Ω–∞ hardcoded –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞ ${VAULT:path/to/secret} –∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –∏–Ω—ä–µ–∫—Ü–∏–∏ ---
log_info "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–º–µ–Ω–µ –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –Ω–∞ Vault-—Å—Å—ã–ª–∫–∏..."
log_warn "–≠—Ç–æ —Ç–∞–∫–∂–µ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –∏–ª–∏ –ø–æ–ª—É–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –¥–æ—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤. –ü—Ä–∏–º–µ—Ä—ã:"
log_warn "  –í–º–µ—Å—Ç–æ –∂–µ—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∏–Ω—ä–µ—Ü–∏—Ä–æ–≤–∞–Ω–∞:"
log_warn "    deploy_to_node \$NODE1 \"\${X0TTA6BL4_NODE1_PASSWORD}\""
log_warn "  –î–ª—è Kubernetes –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Vault Agent Injector:"
log_warn "    vault.hashicorp.com/agent-inject-secret-db: \"secret/data/postgres/credentials\""
log_warn "    vault.hashicorp.com/agent-inject-template-db: |"
log_warn "      {{- with secret \"secret/data/postgres/credentials\" -}}"
log_warn "      DB_PASSWORD=\"{{ .Data.data.POSTGRES_PASSWORD }}\""
log_warn "      {{- end -}}"

# --- 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Vault Agent –¥–ª—è –∞–≤—Ç–æ–∏–Ω—ä–µ–∫—Ü–∏–∏ –≤ K8s (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ) ---
# –≠—Ç–∞ –ª–æ–≥–∏–∫–∞ –æ–±—ã—á–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ Kubernetes Manifests –∏–ª–∏ Helm-—á–∞—Ä—Ç–∞—Ö.

# --- 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –∫–ª—é—á–µ–π (Kyber, Dilithium, WireGuard) ---
log_info "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –∫–ª—é—á–µ–π PQC –∏ WireGuard —Å –ø–æ–º–æ—â—å—é Vault (–∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–π —à–∞–≥)..."
log_warn "–≠—Ç–æ —Å–ª–æ–∂–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å, —Ç—Ä–µ–±—É—é—â–∏–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Vault PKI –∏ Transit secrets engines."
log_warn "–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —ç—Ç–æ–≥–æ —à–∞–≥–∞ –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ —Ä–∞–º–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞, –Ω–æ —è–≤–ª—è–µ—Ç—Å—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ–π."

log_info "‚úÖ –°–∫—Ä–∏–ø—Ç vault-migration.sh –∑–∞–≤–µ—Ä—à–∏–ª –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ —à–∞–≥–∏."
log_info "–î–ª—è –ø–æ–ª–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –≤ Vault —Ç—Ä–µ–±—É—é—Ç—Å—è –¥–∞–ª—å–Ω–µ–π—à–∏–µ —Ä—É—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è."