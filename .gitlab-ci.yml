# MaaS x0tta6bl4 - GitLab CI/CD Pipeline
# ========================================
# Complete CI/CD pipeline for MaaS platform deployment
#
# Stages:
# 1. validate    - Code quality, linting, security scanning
# 2. build       - Build Docker images
# 3. test        - Unit, integration, and e2e tests
# 4. security    - Security scanning and vulnerability checks
# 5. deploy      - Deploy to staging/production
# 6. monitor     - Post-deployment monitoring

stages:
  - validate
  - build
  - test
  - security
  - deploy
  - monitor

variables:
  # Docker configuration
  DOCKER_REGISTRY: registry.gitlab.com
  DOCKER_IMAGE_PREFIX: maas-x0tta6bl4
  DOCKER_TLS_CERTDIR: "/certs"
  
  # Kubernetes configuration
  KUBE_NAMESPACE_STAGING: maas-staging
  KUBE_NAMESPACE_PRODUCTION: maas-production
  
  # Helm configuration
  HELM_CHART_PATH: deploy/helm/maas
  HELM_RELEASE_NAME: maas
  
  # Python configuration
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  
  # Test configuration
  PYTEST_COVERAGE_THRESHOLD: 75
  COVERAGE_REPORT_DIR: coverage-reports

# ============================================================================
# Cache configuration
# ============================================================================
.cache_python:
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .cache/pip
      - venv/

.cache_node:
  cache:
    key: "${CI_JOB_NAME}-node"
    paths:
      - node_modules/

# ============================================================================
# Stage 1: Validate
# ============================================================================

validate:lint:
  stage: validate
  image: python:${PYTHON_VERSION}
  extends: .cache_python
  script:
    - pip install ruff black isort mypy
    - |
      echo "üîç Running code linting..."
      ruff check src/ --output-format=gitlab > ruff-report.json || true
      black --check src/ --diff || true
      isort --check-only src/ --diff || true
    - |
      echo "üîç Running type checking..."
      mypy src/ --ignore-missing-imports --no-error-summary || true
  artifacts:
    reports:
      codequality: ruff-report.json
    expire_in: 7 days
  allow_failure: true

validate:helm:
  stage: validate
  image: alpine/k8s:1.28.3
  script:
    - |
      echo "üîç Validating Helm chart..."
      helm lint ${HELM_CHART_PATH}
      helm template test-release ${HELM_CHART_PATH} --debug > /dev/null
    - |
      echo "üîç Validating Kubernetes manifests..."
      helm template test-release ${HELM_CHART_PATH} | kubeval --strict || true
  allow_failure: true

validate:openapi:
  stage: validate
  image: node:18-alpine
  script:
    - npm install -g @apidevtools/swagger-cli
    - |
      echo "üîç Validating OpenAPI specifications..."
      if [ -f "docs/api/openapi.yaml" ]; then
        swagger-cli validate docs/api/openapi.yaml
      fi
      if [ -f "docs/api/maas_openapi.yaml" ]; then
        swagger-cli validate docs/api/maas_openapi.yaml
      fi
  allow_failure: true

# ============================================================================
# Stage 2: Build
# ============================================================================

build:api:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    IMAGE_NAME: ${DOCKER_REGISTRY}/${DOCKER_IMAGE_PREFIX}/api
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $DOCKER_REGISTRY
    - |
      echo "üî® Building API Docker image..."
      docker build \
        -f docker/Dockerfile.api \
        -t ${IMAGE_NAME}:${CI_COMMIT_SHA} \
        -t ${IMAGE_NAME}:${CI_COMMIT_REF_NAME} \
        -t ${IMAGE_NAME}:latest \
        --build-arg PYTHON_VERSION=${PYTHON_VERSION} \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        --build-arg GIT_COMMIT=${CI_COMMIT_SHA} \
        .
    - |
      echo "üì§ Pushing Docker image..."
      docker push ${IMAGE_NAME}:${CI_COMMIT_SHA}
      docker push ${IMAGE_NAME}:${CI_COMMIT_REF_NAME}
      if [ "$CI_COMMIT_REF_NAME" == "main" ]; then
        docker push ${IMAGE_NAME}:latest
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_MERGE_REQUEST_IID

build:worker:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    IMAGE_NAME: ${DOCKER_REGISTRY}/${DOCKER_IMAGE_PREFIX}/worker
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $DOCKER_REGISTRY
    - |
      echo "üî® Building Worker Docker image..."
      docker build \
        -f docker/Dockerfile.worker \
        -t ${IMAGE_NAME}:${CI_COMMIT_SHA} \
        -t ${IMAGE_NAME}:${CI_COMMIT_REF_NAME} \
        -t ${IMAGE_NAME}:latest \
        --build-arg PYTHON_VERSION=${PYTHON_VERSION} \
        .
    - docker push ${IMAGE_NAME}:${CI_COMMIT_SHA}
    - docker push ${IMAGE_NAME}:${CI_COMMIT_REF_NAME}
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

build:controller:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    IMAGE_NAME: ${DOCKER_REGISTRY}/${DOCKER_IMAGE_PREFIX}/controller
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $DOCKER_REGISTRY
    - |
      echo "üî® Building Controller Docker image..."
      docker build \
        -f docker/Dockerfile.controller \
        -t ${IMAGE_NAME}:${CI_COMMIT_SHA} \
        -t ${IMAGE_NAME}:${CI_COMMIT_REF_NAME} \
        -t ${IMAGE_NAME}:latest \
        --build-arg PYTHON_VERSION=${PYTHON_VERSION} \
        .
    - docker push ${IMAGE_NAME}:${CI_COMMIT_SHA}
    - docker push ${IMAGE_NAME}:${CI_COMMIT_REF_NAME}
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# ============================================================================
# Stage 3: Test
# ============================================================================

test:unit:
  stage: test
  image: python:${PYTHON_VERSION}
  extends: .cache_python
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  script:
    - pip install -r requirements.txt -r requirements-dev.txt
    - |
      echo "üß™ Running unit tests..."
      mkdir -p ${COVERAGE_REPORT_DIR}
      pytest tests/unit/ \
        -v \
        --tb=short \
        --cov=src \
        --cov-report=term \
        --cov-report=xml:${COVERAGE_REPORT_DIR}/coverage.xml \
        --cov-report=html:${COVERAGE_REPORT_DIR}/html \
        --cov-fail-under=${PYTEST_COVERAGE_THRESHOLD} \
        --junit-xml=test-results/unit.xml
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: ${COVERAGE_REPORT_DIR}/coverage.xml
      junit: test-results/*.xml
    paths:
      - ${COVERAGE_REPORT_DIR}/
    expire_in: 30 days

test:integration:
  stage: test
  image: python:${PYTHON_VERSION}
  extends: .cache_python
  services:
    - postgres:15
    - redis:7
  variables:
    POSTGRES_DB: maas_test
    POSTGRES_USER: test
    POSTGRES_PASSWORD: test
    DATABASE_URL: postgresql://test:test@postgres:5432/maas_test
    REDIS_URL: redis://redis:6379/0
  script:
    - pip install -r requirements.txt -r requirements-dev.txt
    - |
      echo "üß™ Running integration tests..."
      pytest tests/integration/ \
        -v \
        --tb=short \
        --junit-xml=test-results/integration.xml
  artifacts:
    reports:
      junit: test-results/*.xml
    expire_in: 30 days
  allow_failure: true

test:helm:
  stage: test
  image: alpine/k8s:1.28.3
  script:
    - pip install pytest pyyaml
    - |
      echo "üß™ Running Helm chart tests..."
      pytest tests/helm/ -v --tb=short
  allow_failure: true

test:mutation:
  stage: test
  image: python:${PYTHON_VERSION}
  extends: .cache_python
  script:
    - pip install -r requirements.txt -r requirements-dev.txt
    - pip install mutmut
    - |
      echo "üß¨ Running mutation tests..."
      mutmut run --paths-to-mutate src/api/maas/ --runner "pytest tests/unit/test_maas_package.py" || true
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_MERGE_REQUEST_IID

# ============================================================================
# Stage 4: Security
# ============================================================================

security:sast:
  stage: security
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  script:
    - |
      echo "üîí Running SAST scan..."
      # Using GitLab SAST or custom scanner
      docker run --rm -v $(pwd):/app -w /app \
        aquasec/trivy:latest fs --security-checks vuln,secret /app
  artifacts:
    reports:
      sast: gl-sast-report.json
    expire_in: 30 days
  allow_failure: true

security:container-scan:
  stage: security
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  variables:
    IMAGE_NAME: ${DOCKER_REGISTRY}/${DOCKER_IMAGE_PREFIX}/api:${CI_COMMIT_SHA}
  script:
    - |
      echo "üîí Scanning container image..."
      docker run --rm \
        -v /var/run/docker.sock:/var/run/docker.sock \
        aquasec/trivy:latest image --security-checks vuln ${IMAGE_NAME}
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

security:dependency-check:
  stage: security
  image: python:${PYTHON_VERSION}
  extends: .cache_python
  script:
    - pip install safety pip-audit
    - |
      echo "üîí Checking dependencies for vulnerabilities..."
      safety check -r requirements.txt --json > safety-report.json || true
      pip-audit --format json > pip-audit-report.json || true
  artifacts:
    paths:
      - safety-report.json
      - pip-audit-report.json
    expire_in: 30 days
  allow_failure: true

security:secrets-scan:
  stage: security
  image: python:${PYTHON_VERSION}
  script:
    - pip install detect-secrets
    - |
      echo "üîí Scanning for secrets..."
      detect-secrets scan --all-files > secrets-baseline.json || true
      detect-secrets audit secrets-baseline.json || true
  artifacts:
    paths:
      - secrets-baseline.json
    expire_in: 30 days
  allow_failure: true

# ============================================================================
# Stage 5: Deploy
# ============================================================================

deploy:staging:
  stage: deploy
  image: alpine/k8s:1.28.3
  environment:
    name: staging
    url: https://api.staging.maas-x0tta6bl4.local
  variables:
    KUBE_NAMESPACE: ${KUBE_NAMESPACE_STAGING}
  script:
    - |
      echo "üöÄ Deploying to staging..."
      kubectl config use-context ${KUBE_CONTEXT_STAGING}
      kubectl create namespace ${KUBE_NAMESPACE} --dry-run=client -o yaml | kubectl apply -f -
    - |
      echo "üì¶ Deploying with Helm..."
      helm upgrade --install ${HELM_RELEASE_NAME} ${HELM_CHART_PATH} \
        --namespace ${KUBE_NAMESPACE} \
        --values ${HELM_CHART_PATH}/values-staging.yaml \
        --set api.image.tag=${CI_COMMIT_SHA} \
        --set worker.image.tag=${CI_COMMIT_SHA} \
        --set controller.image.tag=${CI_COMMIT_SHA} \
        --set stripe.secretKey=${STRIPE_TEST_SECRET_KEY} \
        --set stripe.webhookSecret=${STRIPE_TEST_WEBHOOK_SECRET} \
        --timeout 10m \
        --wait \
        --atomic
    - |
      echo "‚úÖ Deployment complete"
      kubectl get pods -n ${KUBE_NAMESPACE}
      kubectl get services -n ${KUBE_NAMESPACE}
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  when: manual

deploy:production:
  stage: deploy
  image: alpine/k8s:1.28.3
  environment:
    name: production
    url: https://api.maas-x0tta6bl4.local
  variables:
    KUBE_NAMESPACE: ${KUBE_NAMESPACE_PRODUCTION}
  script:
    - |
      echo "üöÄ Deploying to production..."
      kubectl config use-context ${KUBE_CONTEXT_PRODUCTION}
    - |
      echo "üì¶ Running pre-deployment checks..."
      helm template ${HELM_RELEASE_NAME} ${HELM_CHART_PATH} \
        --values ${HELM_CHART_PATH}/values-production.yaml \
        --dry-run
    - |
      echo "üì¶ Deploying with Helm..."
      helm upgrade --install ${HELM_RELEASE_NAME} ${HELM_CHART_PATH} \
        --namespace ${KUBE_NAMESPACE} \
        --values ${HELM_CHART_PATH}/values-production.yaml \
        --set api.image.tag=${CI_COMMIT_TAG:-${CI_COMMIT_SHA}} \
        --set worker.image.tag=${CI_COMMIT_TAG:-${CI_COMMIT_SHA}} \
        --set controller.image.tag=${CI_COMMIT_TAG:-${CI_COMMIT_SHA}} \
        --set stripe.secretKey=${STRIPE_LIVE_SECRET_KEY} \
        --set stripe.webhookSecret=${STRIPE_LIVE_WEBHOOK_SECRET} \
        --timeout 15m \
        --wait \
        --atomic \
        --history-max 10
    - |
      echo "‚úÖ Production deployment complete"
      kubectl get pods -n ${KUBE_NAMESPACE}
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == "main"
  when: manual

# ============================================================================
# Stage 6: Monitor
# ============================================================================

monitor:health-check:
  stage: monitor
  image: alpine/k8s:1.28.3
  script:
    - |
      echo "üè• Running health checks..."
      kubectl rollout status deployment/${HELM_RELEASE_NAME}-api -n ${KUBE_NAMESPACE_STAGING}
      kubectl rollout status deployment/${HELM_RELEASE_NAME}-worker -n ${KUBE_NAMESPACE_STAGING}
    - |
      echo "üìä Checking pod health..."
      kubectl get pods -n ${KUBE_NAMESPACE_STAGING} -l app.kubernetes.io/name=maas
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  needs: ["deploy:staging"]

monitor:smoke-test:
  stage: monitor
  image: python:${PYTHON_VERSION}
  script:
    - pip install requests pytest
    - |
      echo "üí® Running smoke tests..."
      pytest tests/smoke/ -v --tb=short -k "staging"
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  needs: ["deploy:staging", "monitor:health-check"]
  allow_failure: true

# ============================================================================
# Scheduled Jobs
# ============================================================================

schedule:nightly-tests:
  stage: test
  image: python:${PYTHON_VERSION}
  extends: .cache_python
  script:
    - pip install -r requirements.txt -r requirements-dev.txt
    - |
      echo "üåô Running nightly test suite..."
      pytest tests/ -v --tb=short --cov=src --cov-report=xml
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

schedule:dependency-update-check:
  stage: validate
  image: python:${PYTHON_VERSION}
  script:
    - pip install pip-outdated
    - |
      echo "üîÑ Checking for outdated dependencies..."
      pip-outdated || true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  allow_failure: true

# ============================================================================
# Rollback
# ============================================================================

rollback:staging:
  stage: deploy
  image: alpine/k8s:1.28.3
  environment:
    name: staging
  script:
    - |
      echo "‚è™ Rolling back staging deployment..."
      helm rollback ${HELM_RELEASE_NAME} -n ${KUBE_NAMESPACE_STAGING}
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
  when: manual

rollback:production:
  stage: deploy
  image: alpine/k8s:1.28.3
  environment:
    name: production
  script:
    - |
      echo "‚è™ Rolling back production deployment..."
      helm rollback ${HELM_RELEASE_NAME} -n ${KUBE_NAMESPACE_PRODUCTION}
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
  when: manual
