apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: proxy-secrets
  namespace: proxy-infrastructure
spec:
  encryptedData:
    master-key: AgByA...<encrypted-master-key>...
    node-agent-api-key: AgByA...<encrypted-api-key>...
    oxylabs-username: AgByA...<encrypted-username>...
    oxylabs-password: AgByA...<encrypted-password>...
    jwt-secret: AgByA...<encrypted-jwt-secret>...
  template:
    metadata:
      name: proxy-secrets
      namespace: proxy-infrastructure
    type: Opaque
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: proxy-tls
  namespace: proxy-infrastructure
spec:
  encryptedData:
    tls.crt: AgByA...<encrypted-cert>...
    tls.key: AgByA...<encrypted-key>...
  template:
    metadata:
      name: proxy-tls
      namespace: proxy-infrastructure
    type: kubernetes.io/tls
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: webhook-secrets
  namespace: proxy-infrastructure
spec:
  encryptedData:
    slack-webhook-url: AgByA...<encrypted-url>...
    telegram-bot-token: AgByA...<encrypted-token>...
    telegram-chat-id: AgByA...<encrypted-chat-id>...
    discord-webhook-url: AgByA...<encrypted-url>...
    custom-webhooks: AgByA...<encrypted-webhooks>...
  template:
    metadata:
      name: webhook-secrets
      namespace: proxy-infrastructure
    type: Opaque
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: proxy-secrets-external
  namespace: proxy-infrastructure
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: vault-backend
  target:
    name: proxy-secrets
    creationPolicy: Owner
    deletionPolicy: Retain
  data:
  - secretKey: master-key
    remoteRef:
      key: proxy-infrastructure/production
      property: master-key
  - secretKey: node-agent-api-key
    remoteRef:
      key: proxy-infrastructure/production
      property: node-agent-api-key
  - secretKey: oxylabs-username
    remoteRef:
      key: proxy-infrastructure/providers
      property: oxylabs-username
  - secretKey: oxylabs-password
    remoteRef:
      key: proxy-infrastructure/providers
      property: oxylabs-password
  - secretKey: jwt-secret
    remoteRef:
      key: proxy-infrastructure/production
      property: jwt-secret
---
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-backend
spec:
  provider:
    vault:
      server: "https://vault.internal:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "proxy-infrastructure"
          serviceAccountRef:
            name: external-secrets-sa
            namespace: proxy-infrastructure
