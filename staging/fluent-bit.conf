[SERVICE]
    Daemon Off
    Flush 5
    Log_Level info
    Parsers_File parsers.conf
    Parsers_File custom_parsers.conf
    HTTP_Server On
    HTTP_Listen 0.0.0.0
    HTTP_Port 2020
    Health_Check On
    HC_Errors_Count 5
    HC_Retry_Failure_Count 5
    HC_Period 60

# Tail x0tta6bl4 logs
[INPUT]
    Name tail
    Path /var/log/x0tta6bl4/*.log
    Parser json
    Tag x0tta6bl4.app
    Refresh_Interval 5
    Mem_Buf_Limit 50MB
    Skip_Long_Lines On

# Tail system logs
[INPUT]
    Name tail
    Path /var/log/syslog
    Parser syslog
    Tag system.syslog
    Refresh_Interval 5
    Mem_Buf_Limit 50MB

# Tail PostgreSQL logs
[INPUT]
    Name tail
    Path /var/log/postgresql/*.log
    Parser postgres
    Tag postgres.log
    Refresh_Interval 5
    Mem_Buf_Limit 50MB

# Docker logs
[INPUT]
    Name docker
    Tag docker.*
    Refresh_Interval 5
    Mem_Buf_Limit 50MB

# Filter to add metadata
[FILTER]
    Name modify
    Match *
    Add environment production
    Add service x0tta6bl4
    Add hostname ${HOSTNAME}

# Filter for error logs
[FILTER]
    Name grep
    Match x0tta6bl4.app
    regex level ERROR|CRITICAL

# Output to Loki
[OUTPUT]
    Name loki
    Match *
    Host loki
    Port 3100
    Labels job=fluent-bit, service=x0tta6bl4
    Label_keys level,request_id,service
    Auto_Kubernetes_Labels On

# Output to stdout for debugging
[OUTPUT]
    Name stdout
    Match x0tta6bl4.app
    Format json_lines

# Backup output to file
[OUTPUT]
    Name file
    Match x0tta6bl4.app
    Path /var/log/x0tta6bl4/fluent-bit-backup
    Format json_lines
