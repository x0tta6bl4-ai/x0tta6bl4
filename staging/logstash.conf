input {
  tcp {
    port => 5000
    codec => json
    type => "app-json"
  }
  
  udp {
    port => 5000
    codec => json
    type => "app-json-udp"
  }
  
  syslog {
    port => 5001
    type => "syslog"
  }
}

filter {
  # Parse JSON logs
  if [type] == "app-json" or [type] == "app-json-udp" {
    if [message] {
      json {
        source => "message"
        target => "parsed"
      }
    }
  }
  
  # Add geoIP if available
  if [ip_address] {
    geoip {
      source => "ip_address"
      target => "geoip"
    }
  }
  
  # Add host metadata
  mutate {
    add_field => { "[@metadata][index_name]" => "x0tta6bl4-%{+YYYY.MM.dd}" }
    add_field => { "environment" => "production" }
    add_field => { "service" => "x0tta6bl4" }
  }
  
  # Extract level for severity
  if [level] == "ERROR" or [level] == "CRITICAL" {
    mutate {
      add_field => { "severity" => "high" }
      add_tag => ["error", "alert"]
    }
  } else if [level] == "WARNING" {
    mutate {
      add_field => { "severity" => "medium" }
      add_tag => ["warning"]
    }
  } else {
    mutate {
      add_field => { "severity" => "low" }
    }
  }
  
  # Calculate response time metrics
  if [duration_ms] {
    if [duration_ms] > 1000 {
      mutate {
        add_tag => ["slow_request"]
      }
    }
  }
  
  # Drop health check logs if needed
  if [path] =~ /^\/health/ {
    mutate {
      add_tag => ["health_check"]
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "%{[@metadata][index_name]}"
  }
  
  # Send alerts for errors
  if "alert" in [tags] {
    email {
      to => "ops@x0tta6bl4.mesh"
      subject => "ALERT: %{level} in x0tta6bl4"
      body => "Error: %{message}\nTimestamp: %{timestamp}"
    }
  }
  
  # Debug output
  stdout {
    codec => rubydebug
  }
}
