version: '3.9'

services:
  # --- Control Plane (FastAPI) ---
  control-plane:
    build:
      context: .
      dockerfile: Dockerfile.production
    ports:
      - "8010:8000" # Changed from 8000 to avoid conflict
    environment:
      DATABASE_URL: postgresql://maas_user:maas_pass@db:5432/maas_db
      REDIS_URL: redis://redis:6379/0
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: ${VAULT_ROOT_TOKEN:-root}
      X0TTA6BL4_PRODUCTION: "true"
    deploy:
      resources:
        limits:
          memory: 512M # Strict limit for low-RAM environment
    depends_on:
      db:
        condition: service_healthy
      vault:
        condition: service_started
    networks:
      - maas-network

  # --- Marketplace Janitor ---
  janitor:
    build:
      context: .
      dockerfile: Dockerfile.production
    command: ["python", "src/services/run_janitor.py"]
    environment:
      DATABASE_URL: postgresql://maas_user:maas_pass@db:5432/maas_db
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: ${VAULT_ROOT_TOKEN:-root}
    deploy:
      resources:
        limits:
          memory: 256M
    depends_on:
      db:
        condition: service_healthy
    networks:
      - maas-network

  # --- Database (PostgreSQL) ---
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: maas_user
      POSTGRES_PASSWORD: maas_pass
      POSTGRES_DB: maas_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U maas_user -d maas_db"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - maas-network

  # --- Secret Management (Vault) ---
  vault:
    image: hashicorp/vault:1.15
    ports:
      - "8201:8200" # Changed from 8200
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_ROOT_TOKEN:-root}
      VAULT_ADDR: http://0.0.0.0:8200
    cap_add:
      - IPC_LOCK
    deploy:
      resources:
        limits:
          memory: 256M
    networks:
      - maas-network

  # --- Cache (Redis) ---
  redis:
    image: redis:7-alpine
    deploy:
      resources:
        limits:
          memory: 128M
    networks:
      - maas-network

networks:
  maas-network:
    driver: bridge

volumes:
  postgres_data:
