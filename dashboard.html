<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | x0tta6bl4 MaaS</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ... existing styles ... */
        .chart-container { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid #333; margin-top: 20px; height: 300px; display: none; }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- ... sidebar ... -->
        <div class="sidebar">
            <h2>x0tta6bl4</h2>
            <nav style="margin-top: 40px;">
                <p style="color: var(--accent);">‚óè Overview</p>
                <p>‚öô Meshes</p>
                <p>üí≥ Billing</p>
                <p>üìã Audit Logs</p>
                <p style="margin-top: 40px; cursor: pointer; color: #ff4444;" onclick="logout()">‚Üê –í—ã—Ö–æ–¥</p>
            </nav>
        </div>
        
        <div class="main-content">
            <header style="margin-bottom: 40px; display: flex; justify-content: space-between;">
                <div>
                    <h1 id="user-email">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                    <p id="user-plan" style="color: var(--text-gray);">–ü–ª–∞–Ω: ---</p>
                </div>
                <div id="security-summary" style="text-align: right;">
                    <span class="status-badge status-active">PQC Secured</span>
                </div>
            </header>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Active Meshes</h3>
                    <div id="stat-meshes" class="value">0</div>
                </div>
                <div class="stat-card">
                    <h3>Nodes HW-Rooted</h3>
                    <div id="stat-hw-nodes" class="value">0</div>
                </div>
                <div class="stat-card">
                    <h3>Security Level</h3>
                    <div class="value">High</div>
                </div>
            </div>

            <!-- Analytics Overlay (Hidden by default) -->
            <div id="analytics-section" style="display:none; margin-bottom: 40px;">
                <div class="section-title">
                    <h2 id="analytics-title">Analytics: Mesh ...</h2>
                    <button class="btn-pay" onclick="document.getElementById('analytics-section').style.display='none'">Close</button>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div class="chart-container" style="display: block;">
                        <canvas id="healthChart"></canvas>
                    </div>
                    <div class="chart-container" style="display: block;">
                        <canvas id="trafficChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="section-title">
                <h2>–í–∞—à–∏ Mesh-—Å–µ—Ç–∏</h2>
                <button class="btn-pay" onclick="alert('Deployment coming soon')">+ New Mesh</button>
            </div>
            <table class="data-table" id="mesh-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Created</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JS populated -->
                </tbody>
            </table>

            <div class="section-title" style="margin-top: 40px;">
                <h2>–ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã</h2>
            </div>
            <table class="data-table" id="invoice-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JS populated -->
                </tbody>
            </table>

            <div class="section-title" style="margin-top: 40px;">
                <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è (Audit)</h2>
            </div>
            <table class="data-table" id="audit-table">
                <thead>
                    <tr>
                        <th>Action</th>
                        <th>Status</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- JS populated -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Auth Check
        const apiKey = localStorage.getItem('x0t_api_key');
        if (!apiKey) {
            window.location.href = '/login.html';
        }

        function logout() {
            localStorage.removeItem('x0t_api_key');
            localStorage.removeItem('x0t_user_email');
            window.location.href = '/login.html';
        }

        async function fetchDashboard() {
            try {
                const response = await fetch('/api/v1/maas/dashboard/summary', {
                    headers: { 'X-API-Key': apiKey }
                });
                if (response.status === 401 || response.status === 403) {
                    logout(); // Token expired or invalid
                    return;
                }
                if (!response.ok) throw new Error('API Error');
                
                const data = await response.json();
                
                // User info
                document.getElementById('user-email').textContent = data.user.email;
                document.getElementById('user-plan').textContent = `–ü–ª–∞–Ω: ${data.user.plan.toUpperCase()}`;
                
                // Stats
                document.getElementById('stat-meshes').textContent = data.stats.total_meshes;
                document.getElementById('stat-hw-nodes').textContent = data.stats.security.HARDWARE_ROOTED;

                // Meshes
                const meshBody = document.querySelector('#mesh-table tbody');
                meshBody.innerHTML = data.meshes.map(m => `
                    <tr>
                        <td><code>${m.id}</code></td>
                        <td>${m.name}</td>
                        <td><span class="status-badge status-active">${m.status}</span></td>
                        <td>
                            <button class="btn-pay" style="font-size: 12px; padding: 4px 8px;" onclick="loadAnalytics('${m.id}', '${m.name}')">Stats</button>
                        </td>
                    </tr>
                `).join('');

                // ... (rest of fetchDashboard)
            } catch (err) {
                console.error(err);
            }
        }

        let healthChartInstance = null;
        let trafficChartInstance = null;

        async function loadAnalytics(meshId, meshName) {
            document.getElementById('analytics-section').style.display = 'block';
            document.getElementById('analytics-title').textContent = `Analytics: ${meshName}`;
            
            // Scroll to analytics
            document.getElementById('analytics-section').scrollIntoView({ behavior: 'smooth' });

            const apiKey = localStorage.getItem('x0t_api_key');
            try {
                const response = await fetch(`/api/v1/maas/analytics/${meshId}/timeseries`, {
                    headers: { 'X-API-Key': apiKey }
                });
                const tsData = await response.json();
                
                const labels = tsData.data.map(d => new Date(d.timestamp).getHours() + ':00');
                const healthData = tsData.data.map(d => d.health);
                const trafficData = tsData.data.map(d => d.traffic_mbps);

                // Render Health Chart
                const ctxHealth = document.getElementById('healthChart').getContext('2d');
                if (healthChartInstance) healthChartInstance.destroy();
                healthChartInstance = new Chart(ctxHealth, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Mesh Health (%)',
                            data: healthData,
                            borderColor: '#4ade80',
                            backgroundColor: 'rgba(74, 222, 128, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: 'white' } } },
                        scales: {
                            y: { beginAtZero: true, max: 100, grid: { color: '#333' }, ticks: { color: '#aaa' } },
                            x: { grid: { display: false }, ticks: { color: '#aaa' } }
                        }
                    }
                });

                // Render Traffic Chart
                const ctxTraffic = document.getElementById('trafficChart').getContext('2d');
                if (trafficChartInstance) trafficChartInstance.destroy();
                trafficChartInstance = new Chart(ctxTraffic, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Traffic (Mbps)',
                            data: trafficData,
                            backgroundColor: '#00f2ff',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { labels: { color: 'white' } } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#333' }, ticks: { color: '#aaa' } },
                            x: { grid: { display: false }, ticks: { color: '#aaa' } }
                        }
                    }
                });

            } catch (e) {
                console.error("Failed to load analytics", e);
                alert("Analytics data unavailable");
            }
        }
                invBody.innerHTML = data.pending_invoices.map(inv => `
                    <tr>
                        <td><code>${inv.id}</code></td>
                        <td>${inv.amount} ${inv.currency}</td>
                        <td>${new Date(inv.issued_at).toLocaleDateString()}</td>
                        <td><button class="btn-pay" onclick="startCheckout('${inv.id}')">Pay via Stripe</button></td>
                    </tr>
                `).join('') || '<tr><td colspan="4">–í—Å–µ –∏–Ω–≤–æ–π—Å—ã –æ–ø–ª–∞—á–µ–Ω—ã</td></tr>';

                // Audit
                const auditBody = document.querySelector('#audit-table tbody');
                auditBody.innerHTML = data.recent_audit.map(log => `
                    <tr>
                        <td>${log.action}</td>
                        <td><code>${log.status_code}</code></td>
                        <td>${new Date(log.created_at).toLocaleTimeString()}</td>
                    </tr>
                `).join('');

            } catch (err) {
                console.error(err);
                // Redirect to login or show error
            }
        }

        async function startCheckout(invoiceId) {
            const apiKey = localStorage.getItem('x0t_api_key') || 'admin-key';
            const response = await fetch(`/api/v1/maas/billing/invoices/${invoiceId}/checkout`, {
                headers: { 'X-API-Key': apiKey }
            });
            const data = await response.json();
            if (data.url) {
                window.location.href = data.url;
            } else {
                alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–µ—Å—Å–∏–∏');
            }
        }

        fetchDashboard();
    </script>
</body>
</html>
