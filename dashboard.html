<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | x0tta6bl4 MaaS</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="dashboard-theme">
    <div class="dashboard-container">
        <div class="sidebar">
            <h2 style="color: white; margin-bottom: 40px; display: flex; align-items: center;">
                <span style="color: var(--accent); margin-right: 10px;">‚ö°</span> x0tta6bl4
            </h2>
            <nav>
                <div class="nav-item active" data-tab="overview" onclick="showTab('overview')">‚óè Overview</div>
                <div class="nav-item" data-tab="marketplace" onclick="showTab('marketplace')">üõí Marketplace</div>
                <div class="nav-item" data-tab="nodes" onclick="showTab('nodes')">üñ• Nodes</div>
                <div class="nav-item" data-tab="billing" onclick="showTab('billing')">üí≥ Billing</div>
                <div class="nav-item" data-tab="audit" onclick="showTab('audit')">üìã Audit Logs</div>
                <div style="margin-top: 40px; cursor: pointer; color: #ff4444; padding: 12px 15px; border-radius: 8px;" onclick="logout()" onmouseover="this.style.background='rgba(255,68,68,0.1)'" onmouseout="this.style.background='transparent'">‚Üê –í—ã—Ö–æ–¥</div>
            </nav>
        </div>
        
        <div class="main-content">
            <!-- TAB: OVERVIEW -->
            <div id="tab-overview" class="tab-content">
                <header style="margin-bottom: 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 20px;">
                    <div>
                        <h1 id="user-email" style="margin:0; font-size: 28px; color: white;">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                        <p id="user-plan" style="color: var(--text-gray); margin: 5px 0 0 0; font-size: 14px;">–ü–ª–∞–Ω: ---</p>
                    </div>
                    <div id="security-summary">
                        <span class="status-badge status-active" style="box-shadow: 0 0 20px rgba(74, 222, 128, 0.2);">PQC Secured</span>
                    </div>
                </header>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Active Meshes</h3>
                        <div id="stat-meshes" class="value">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Nodes HW-Rooted</h3>
                        <div id="stat-hw-nodes" class="value">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Security Level</h3>
                        <div class="value" style="color: #4ade80;">Enterprise</div>
                    </div>
                </div>

                <div class="section-title">
                    <h2>–°–µ—Ç–µ–≤–∞—è —Ç–æ–ø–æ–ª–æ–≥–∏—è (Live)</h2>
                </div>
                <div id="topology-container" style="background: #000; height: 350px; border-radius: 12px; border: 1px solid #333; margin-bottom: 40px; position: relative; overflow: hidden;">
                    <canvas id="topoCanvas"></canvas>
                </div>

                <div id="analytics-section" style="display:none; margin-bottom: 40px;">
                    <div class="section-title">
                        <h2 id="analytics-title">Analytics</h2>
                        <button class="btn-pay" style="background: #333; color: white;" onclick="document.getElementById('analytics-section').style.display='none'">Close</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="chart-container"><canvas id="healthChart"></canvas></div>
                        <div class="chart-container"><canvas id="trafficChart"></canvas></div>
                    </div>
                </div>

                <div class="section-title">
                    <h2>–í–∞—à–∏ Mesh-—Å–µ—Ç–∏</h2>
                    <button class="btn-pay" onclick="alert('Deployment logic starting...')">+ New Mesh</button>
                </div>
                <table class="data-table" id="mesh-table">
                    <thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- TAB: MARKETPLACE -->
            <div id="tab-marketplace" class="tab-content" style="display:none;">
                <div class="section-title"><h2>Marketplace: P2P Infrastructure</h2></div>
                <div class="stats-grid" id="marketplace-list"></div>
            </div>

            <!-- TAB: NODES -->
            <div id="tab-nodes" class="tab-content" style="display:none;">
                <div class="section-title"><h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–∑–ª–∞–º–∏</h2></div>
                <h3>–û–∂–∏–¥–∞—é—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è (Pending)</h3>
                <table class="data-table" id="pending-nodes-table">
                    <thead><tr><th>Node ID</th><th>Class</th><th>Attestation</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- TAB: BILLING -->
            <div id="tab-billing" class="tab-content" style="display:none;">
                <div class="section-title"><h2>–ë–∏–ª–ª–∏–Ω–≥ –∏ –ø–æ–¥–ø–∏—Å–∫–∏</h2></div>
                
                <div class="stats-grid">
                    <div class="stat-card" style="border-top: 4px solid var(--accent);">
                        <h3>Starter</h3>
                        <div class="value">$0</div>
                        <p style="color: var(--text-gray); font-size: 14px; margin-top: 10px;">5 —É–∑–ª–æ–≤, –±–∞–∑–æ–≤–∞—è –∑–∞—â–∏—Ç–∞</p>
                        <button class="btn-pay" style="width: 100%; margin-top: 20px; background: transparent; border: 1px solid var(--border); color: white;" disabled>–¢–µ–∫—É—â–∏–π –ø–ª–∞–Ω</button>
                    </div>
                    <div class="stat-card" style="border-top: 4px solid var(--success); transform: scale(1.05); box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                        <div style="position: absolute; top: -12px; right: 20px; background: var(--success); color: black; padding: 2px 10px; border-radius: 10px; font-size: 10px; font-weight: bold;">POPULAR</div>
                        <h3>Professional</h3>
                        <div class="value">$49<span style="font-size: 14px; color: var(--text-gray);">/–º–µ—Å</span></div>
                        <p style="color: var(--text-gray); font-size: 14px; margin-top: 10px;">50 —É–∑–ª–æ–≤, PQC-Identity, Priority Support</p>
                        
                        <div style="margin-top: 15px;">
                            <input type="text" id="promo-code" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥" style="background: #000; border: 1px solid #333; color: #fff; padding: 8px; width: 100%; border-radius: 5px; font-size: 12px;">
                        </div>
                        
                        <button class="btn-pay" style="width: 100%; margin-top: 10px; background: var(--success);" onclick="upgradePlan('pro')">Upgrade Now</button>
                    </div>
                    <div class="stat-card" style="border-top: 4px solid #a855f7;">
                        <h3>Enterprise</h3>
                        <div class="value">Custom</div>
                        <p style="color: var(--text-gray); font-size: 14px; margin-top: 10px;">Unlimited, Dedicated Infrastructure, SLA</p>
                        <button class="btn-pay" style="width: 100%; margin-top: 20px; background: #a855f7;" onclick="window.location.href='mailto:sales@x0t.io'">Contact Sales</button>
                    </div>
                </div>

                <div class="section-title" style="margin-top: 40px;"><h3>–ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∏–Ω–≤–æ–π—Å—ã</h3></div>
                <table class="data-table" id="invoice-table">
                    <thead><tr><th>ID</th><th>Amount</th><th>Date</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- TAB: AUDIT -->
            <div id="tab-audit" class="tab-content" style="display:none;">
                <div class="section-title"><h2>Audit Log</h2></div>
                <table class="data-table" id="audit-table">
                    <thead><tr><th>Action</th><th>Status</th><th>Time</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const apiKey = localStorage.getItem('x0t_api_key');
        if (!apiKey) {
            window.location.href = '/login.html';
        }

        function logout() {
            localStorage.removeItem('x0t_api_key');
            window.location.href = '/login.html';
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            const target = document.getElementById(`tab-${tabName}`);
            if (target) target.style.display = 'block';
            
            const navItem = document.querySelector(`.nav-item[data-tab="${tabName}"]`);
            if (navItem) navItem.classList.add('active');

            if (tabName === 'marketplace') loadMarketplace();
            if (tabName === 'nodes') loadPendingNodes();
            if (tabName === 'billing') fetchDashboard();
            if (tabName === 'audit') fetchDashboard();
        }

        async function fetchDashboard() {
            try {
                const response = await fetch('/api/v1/maas/dashboard/summary', {
                    headers: { 'X-API-Key': apiKey }
                });
                
                if (response.status === 401) {
                    return logout();
                }
                
                if (!response.ok) {
                    const err = await response.text();
                    throw new Error(`API Error: ${response.status} - ${err}`);
                }

                const data = await response.json();
                
                // User info
                document.getElementById('user-email').textContent = data.user.email;
                document.getElementById('user-plan').textContent = `–ü–ª–∞–Ω: ${data.user.plan.toUpperCase()}`;
                
                // Stats
                document.getElementById('stat-meshes').textContent = data.stats.total_meshes;
                document.getElementById('stat-hw-nodes').textContent = data.stats.security.HARDWARE_ROOTED;

                // Meshes
                const meshBody = document.querySelector('#mesh-table tbody');
                meshBody.innerHTML = data.meshes.map(m => `
                    <tr>
                        <td><code>${m.id}</code></td>
                        <td>${m.name}</td>
                        <td><span class="status-badge status-active">${m.status}</span></td>
                        <td><button class="btn-pay" style="font-size:12px; padding: 5px 10px;" onclick="loadAnalytics('${m.id}', '${m.name}')">Stats</button></td>
                    </tr>
                `).join('') || '<tr><td colspan="4">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–µ—Ç–µ–π</td></tr>';

                // Invoices
                const invBody = document.querySelector('#invoice-table tbody');
                invBody.innerHTML = data.pending_invoices.map(inv => `
                    <tr>
                        <td><code>${inv.id}</code></td>
                        <td>${inv.amount} ${inv.currency}</td>
                        <td>${new Date(inv.issued_at).toLocaleDateString()}</td>
                        <td><button class="btn-pay" onclick="startCheckout('${inv.id}')">Pay via Stripe</button></td>
                    </tr>
                `).join('') || '<tr><td colspan="4">–í—Å–µ –∏–Ω–≤–æ–π—Å—ã –æ–ø–ª–∞—á–µ–Ω—ã</td></tr>';

                // Audit
                const auditBody = document.querySelector('#audit-table tbody');
                auditBody.innerHTML = data.recent_audit.map(log => `
                    <tr>
                        <td>${log.action}</td>
                        <td><code style="color: ${log.status_code < 400 ? '#4ade80' : '#ff4444'}">${log.status_code}</code></td>
                        <td>${new Date(log.created_at).toLocaleTimeString()}</td>
                    </tr>
                `).join('');

                if (data.meshes.length > 0) {
                    drawTopology(data.meshes[0].id);
                }

            } catch (err) { 
                console.error("Dashboard fetch error:", err);
                document.getElementById('user-email').textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏";
                document.getElementById('user-email').style.color = "red";
            }
        }

        async function loadMarketplace() {
            const list = document.getElementById('marketplace-list');
            try {
                const response = await fetch('/api/v1/maas/marketplace/search', { headers: { 'X-API-Key': apiKey } });
                if (!response.ok) throw new Error(`marketplace search failed: ${response.status}`);
                const nodes = await response.json();
                list.innerHTML = nodes.map(n => `
                    <div class="stat-card">
                        <h3>${n.region.toUpperCase()} | ${n.bandwidth_mbps} Mbps</h3>
                        <div class="value">$${n.price_per_hour}/hr</div>
                        <button class="btn-pay" style="width:100%; margin-top:15px;" onclick="rentNode('${n.listing_id}')">Rent Now</button>
                    </div>
                `).join('') || '<p style="color: var(--text-gray); padding: 20px;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É–∑–ª–æ–≤ –¥–ª—è –∞—Ä–µ–Ω–¥—ã</p>';
            } catch (e) {
                console.error("Marketplace error:", e);
                list.innerHTML = '<p style="color: var(--text-gray); padding: 20px;">Marketplace unavailable</p>';
            }
        }

        async function loadPendingNodes() {
            const tableBody = document.querySelector('#pending-nodes-table tbody');
            try {
                const meshesResp = await fetch('/api/v1/maas/dashboard/summary', { headers: { 'X-API-Key': apiKey } });
                if (!meshesResp.ok) throw new Error(`dashboard summary failed: ${meshesResp.status}`);
                const summary = await meshesResp.json();
                if (summary.meshes.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4">–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ Mesh-—Å–µ—Ç—å</td></tr>';
                    return;
                }
                
                const meshId = summary.meshes[0].id;
                const response = await fetch(`/api/v1/maas/${meshId}/pending-nodes`, { headers: { 'X-API-Key': apiKey } });
                if (!response.ok) throw new Error(`pending nodes failed: ${response.status}`);
                const data = await response.json();
                
                tableBody.innerHTML = Object.entries(data.pending || {}).map(([id, node]) => `
                    <tr>
                        <td><code>${id}</code></td>
                        <td>${node.device_class || 'unknown'}</td>
                        <td><span class="status-badge status-active">${node.attestation ? node.attestation.security_level : 'UNKNOWN'}</span></td>
                        <td><button class="btn-pay" style="padding: 5px 10px;" onclick="approveNode('${meshId}', '${id}')">Approve</button></td>
                    </tr>
                `).join('') || '<tr><td colspan="4">–ù–µ—Ç —É–∑–ª–æ–≤, –æ–∂–∏–¥–∞—é—â–∏—Ö –æ–¥–æ–±—Ä–µ–Ω–∏—è</td></tr>';
            } catch (e) {
                console.error("Nodes error:", e);
                tableBody.innerHTML = '<tr><td colspan="4">Pending nodes unavailable</td></tr>';
            }
        }

        let healthChart = null, trafficChart = null;
        async function loadAnalytics(meshId, meshName) {
            document.getElementById('analytics-section').style.display = 'block';
            document.getElementById('analytics-title').textContent = `Analytics: ${meshName}`;
            document.getElementById('analytics-section').scrollIntoView({ behavior: 'smooth' });

            try {
                const response = await fetch(`/api/v1/maas/analytics/${meshId}/timeseries`, { headers: { 'X-API-Key': apiKey } });
                const tsData = await response.json();
                
                const labels = tsData.data.map(d => new Date(d.timestamp).getHours() + ':00');
                
                const render = (id, label, data, color, type='line') => {
                    const ctx = document.getElementById(id).getContext('2d');
                    return new Chart(ctx, {
                        type: type,
                        data: { 
                            labels, 
                            datasets: [{ 
                                label, 
                                data, 
                                borderColor: color, 
                                backgroundColor: color+'22', 
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: true, 
                                tension: 0.4 
                            }] 
                        },
                        options: { 
                            responsive: true, 
                            maintainAspectRatio: false, 
                            plugins: { legend: { labels: { color: '#aaa', font: { size: 12 } } } }, 
                            scales: { 
                                y: { grid: { color: '#222' }, ticks: { color: '#666' } }, 
                                x: { display: true, grid: { display: false }, ticks: { color: '#666' } } 
                            } 
                        }
                    });
                };

                if (healthChart) healthChart.destroy();
                if (trafficChart) trafficChart.destroy();
                healthChart = render('healthChart', 'Mesh Health %', tsData.data.map(d => d.health), '#4ade80');
                trafficChart = render('trafficChart', 'Traffic Mbps', tsData.data.map(d => d.traffic_mbps), '#00f2ff', 'bar');
            } catch (e) { console.error("Analytics load error:", e); }
        }

        function drawTopology(meshId) {
            const canvas = document.getElementById('topoCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const container = document.getElementById('topology-container');
            canvas.width = container.clientWidth; 
            canvas.height = container.clientHeight;

            let nodes = Array.from({length: 12}, (_, i) => ({
                id: i, 
                x: Math.random()*canvas.width, 
                y: Math.random()*canvas.height, 
                vx: (Math.random()-0.5) * 0.8, 
                vy: (Math.random()-0.5) * 0.8
            }));

            function animate() {
                ctx.clearRect(0,0,canvas.width, canvas.height);
                
                // Links
                ctx.strokeStyle = 'rgba(0, 242, 255, 0.1)';
                ctx.lineWidth = 1;
                nodes.forEach((n, i) => {
                    nodes.slice(i+1).forEach(n2 => {
                        const dist = Math.hypot(n.x-n2.x, n.y-n2.y);
                        if (dist < 180) {
                            ctx.beginPath(); 
                            ctx.moveTo(n.x, n.y); 
                            ctx.lineTo(n2.x, n2.y); 
                            ctx.stroke();
                        }
                    });
                    
                    // Update pos
                    n.x += n.vx; n.y += n.vy;
                    if (n.x<0 || n.x>canvas.width) n.vx *= -1;
                    if (n.y<0 || n.y>canvas.height) n.vy *= -1;
                    
                    // Draw node
                    ctx.fillStyle = '#00f2ff';
                    ctx.shadowBlur = 10;
                    ctx.shadowColor = '#00f2ff';
                    ctx.beginPath(); 
                    ctx.arc(n.x, n.y, 3, 0, Math.PI*2); 
                    ctx.fill();
                    ctx.shadowBlur = 0;
                });
                requestAnimationFrame(animate);
            }
            animate();
        }

        async function upgradePlan(plan) {
            const promo = document.getElementById('promo-code')?.value || '';
            try {
                const response = await fetch(`/api/v1/maas/billing/subscriptions/checkout?plan=${plan}&promo=${promo}`, {
                    method: 'POST',
                    headers: { 'X-API-Key': apiKey }
                });
                
                if (!response.ok) {
                    const err = await response.text();
                    alert(`Error: ${err}`);
                    return;
                }
                
                const data = await response.json();
                if (data.url) {
                    window.location.href = data.url;
                }
            } catch (e) {
                console.error("Upgrade error:", e);
                alert("Failed to initiate checkout");
            }
        }

        async function startCheckout(id) {
            const res = await fetch(`/api/v1/maas/billing/invoices/${id}/checkout`, { headers: { 'X-API-Key': apiKey } });
            if (!res.ok) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å checkout-—Å–µ—Å—Å–∏—é');
                return;
            }
            const data = await res.json();
            if (data.url) window.location.href = data.url;
        }

        async function rentNode(listingId) {
            try {
                const summaryResp = await fetch('/api/v1/maas/dashboard/summary', { headers: { 'X-API-Key': apiKey } });
                if (!summaryResp.ok) throw new Error(`dashboard summary failed: ${summaryResp.status}`);
                const summary = await summaryResp.json();
                if (!summary.meshes || summary.meshes.length === 0) {
                    alert('Create a mesh first');
                    return;
                }

                const meshId = summary.meshes[0].id;
                const res = await fetch(`/api/v1/maas/marketplace/rent/${listingId}?mesh_id=${encodeURIComponent(meshId)}`, {
                    method: 'POST',
                    headers: { 'X-API-Key': apiKey },
                });
                if (!res.ok) {
                    const err = await res.text();
                    throw new Error(`rent failed: ${res.status} ${err}`);
                }
                await loadMarketplace();
                alert('Node rented successfully');
            } catch (err) {
                console.error(err);
                alert('Failed to rent node');
            }
        }

        async function approveNode(meshId, nodeId) {
            try {
                const res = await fetch(`/api/v1/maas/${meshId}/approve-node/${nodeId}`, {
                    method: 'POST',
                    headers: {
                        'X-API-Key': apiKey,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ acl_profile: 'default', tags: [] }),
                });
                if (!res.ok) {
                    const err = await res.text();
                    throw new Error(`approve failed: ${res.status} ${err}`);
                }
                await loadPendingNodes();
                alert(`Node ${nodeId} approved`);
            } catch (err) {
                console.error(err);
                alert(`Failed to approve node ${nodeId}`);
            }
        }

        // Initial Load
        fetchDashboard();
    </script>
</body>
</html>
