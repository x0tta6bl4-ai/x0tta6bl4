# Canonical Docker Compose for x0tta6bl4 VPN-MVP Demo
# This file consolidates services from multiple compose files for a complete demo environment.
version: '3.9'

networks:
  vpn-demo-net:
    driver: bridge

volumes:
  prometheus_data:
  grafana_data:
  redis_data:
  spire_data:
  vault_data:

services:
  # --- Monitoring Stack (from docker-compose.yml) ---
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command: --config.file=/etc/prometheus/prometheus.yml --web.enable-lifecycle
    networks:
      - vpn-demo-net

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    networks:
      - vpn-demo-net

  # --- Security Infrastructure (from docker-compose.spire.yml and added Vault) ---
  spire-server:
    image: ghcr.io/spiffe/spire-server:1.9.0
    container_name: spire-server
    hostname: spire-server
    expose:
      - "8081"
    volumes:
      - ./scripts/spire/server-config.conf:/etc/spire/server.conf:ro
      - spire_data:/opt/spire/data
    command: -config /etc/spire/server.conf
    networks:
      - vpn-demo-net

  vault:
    image: hashicorp/vault:latest
    container_name: vault
    ports:
      - "8200:8200"
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=root
      - VAULT_ADDR=http://127.0.0.1:8200
    cap_add:
      - IPC_LOCK
    networks:
      - vpn-demo-net

  # --- Mesh Network Nodes (from docker-compose.mesh-test.yml, adapted) ---
  ingress:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mesh-ingress
    depends_on:
      - spire-server
    environment:
      - NODE_ID=ingress
      - X0TTA6BL4_ENV=production
      - REDIS_URL=redis://redis:6379/0
      - SPIRE_SERVER_ADDRESS=spire-server:8081
    ports:
      - "8081:8080" # Expose API for this node
      - "51820:51820/udp" # Expose WireGuard port for the client
    networks:
      - vpn-demo-net

  relay:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mesh-relay
    depends_on:
      - spire-server
    environment:
      - NODE_ID=relay
      - X0TTA6BL4_ENV=production
      - REDIS_URL=redis://redis:6379/0
      - SPIRE_SERVER_ADDRESS=spire-server:8081
    ports:
      - "8082:8080" # Expose API for this node
    networks:
      - vpn-demo-net

  exit:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mesh-exit
    depends_on:
      - spire-server
    environment:
      - NODE_ID=exit
      - X0TTA6BL4_ENV=production
      - REDIS_URL=redis://redis:6379/0
      - SPIRE_SERVER_ADDRESS=spire-server:8081
    ports:
      - "8083:8080" # Expose API for this node
    # This node needs broader network access to get to the internet
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    networks:
      - vpn-demo-net

  # --- Shared Services ---
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - vpn-demo-net
