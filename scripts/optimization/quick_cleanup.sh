#!/bin/bash

set -euo pipefail

echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "‚ïë          –ö–†–ò–¢–ò–ß–ù–ê–Ø –û–ß–ò–°–¢–ö–ê –î–ò–°–ö–ê (—Ç—Ä–µ–±—É–µ—Ç—Å—è sudo)             ‚ïë"
echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

LOG_FILE="${HOME}/optimization.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

if [ "$EUID" -ne 0 ]; then
    echo "‚ùå –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω —Å sudo"
    echo ""
    echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ: sudo $0"
    exit 1
fi

log "====== –ù–ê–ß–ê–õ–û –ö–†–ò–¢–ò–ß–ù–û–ô –û–ß–ò–°–¢–ö–ò ======"

echo "üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏—Å–∫–∞:"
df -h /
echo ""

echo "üê≥ –®–∞–≥ 1/4: –û—á–∏—Å—Ç–∫–∞ Docker..."
if command -v docker &> /dev/null; then
    log "Stopping all containers..."
    docker stop $(docker ps -a -q) 2>/dev/null || true
    
    log "Running docker system prune..."
    docker system prune -a --volumes -f
    
    log "‚úÖ Docker –æ—á–∏—â–µ–Ω"
else
    log "Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi
echo ""

echo "üì¶ –®–∞–≥ 2/4: –û—á–∏—Å—Ç–∫–∞ APT –∫—ç—à–∞..."
apt-get clean
apt-get autoclean -y
log "‚úÖ APT –∫—ç—à –æ—á–∏—â–µ–Ω"
echo ""

echo "üìù –®–∞–≥ 3/4: –û—á–∏—Å—Ç–∫–∞ –∂—É—Ä–Ω–∞–ª–æ–≤ (–æ—Å—Ç–∞–≤–∏—Ç—å 3 –¥–Ω—è)..."
journalctl --vacuum-time=3d
log "‚úÖ –ñ—É—Ä–Ω–∞–ª—ã –æ—á–∏—â–µ–Ω—ã"
echo ""

echo "üóëÔ∏è  –®–∞–≥ 4/4: –û—á–∏—Å—Ç–∫–∞ temporary —Ñ–∞–π–ª–æ–≤..."
find /tmp -type f -atime +1 -delete 2>/dev/null || true
find /var/tmp -type f -atime +1 -delete 2>/dev/null || true
log "‚úÖ Temporary —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã"
echo ""

log "====== –û–ß–ò–°–¢–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê ======"

echo "üìä –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏—Å–∫–∞ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏:"
df -h /
echo ""

echo "‚úÖ –ö—Ä–∏—Ç–∏—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üìù –õ–æ–≥: $LOG_FILE"
