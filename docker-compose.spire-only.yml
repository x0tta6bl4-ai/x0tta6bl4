services:
  spire-server:
    image: ghcr.io/spiffe/spire-server:1.8.6
    container_name: spire-server
    hostname: spire-server
    expose:
      - 8081
    volumes:
      - ./scripts/spire/server-config.conf:/etc/spire/server.conf:ro
      - spire-data:/spire/data
    command:
      - -config=/etc/spire/server.conf
    networks:
      - spire-net
    healthcheck:
      test: ["CMD", "spire-server", "healthcheck"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  spire-agent:
    image: ghcr.io/spiffe/spire-agent:1.8.6
    container_name: spire-agent
    hostname: spire-agent
    depends_on:
      spire-server:
        condition: service_healthy
    volumes:
      - ./scripts/spire/agent-config.conf:/etc/spire/agent.conf:ro
      - /tmp/spire-agent/public:/spire-agent-socket-dir
      - /var/run/docker.sock:/var/run/docker.sock
    command:
      - -config=/etc/spire/agent.conf
    networks:
      - spire-net
    healthcheck:
      test: ["CMD", "spire-agent", "healthcheck"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

volumes:
  spire-data:

networks:
  spire-net:
    driver: bridge
