#!/usr/bin/env bash
set -euo pipefail

ROOT="$(git rev-parse --show-toplevel)"
CHECK_SCRIPT="$ROOT/scripts/agents/check_swarm_ownership.py"
COORD_SCRIPT="$ROOT/scripts/agents/swarm_coord.py"

if [[ -z "${SWARM_AGENT:-}" ]]; then
  exit 0
fi

if [[ ! -f "$CHECK_SCRIPT" ]]; then
  echo "[swarm] check script not found: $CHECK_SCRIPT" >&2
  exit 2
fi

"$CHECK_SCRIPT" --agent "$SWARM_AGENT"

if [[ ! -f "$COORD_SCRIPT" ]]; then
  echo "[swarm] coordinator script not found: $COORD_SCRIPT" >&2
  exit 2
fi

TTL="${SWARM_LEASE_TTL:-1800}"
exec "$COORD_SCRIPT" ensure-staged --agent "$SWARM_AGENT" --ttl "$TTL"
