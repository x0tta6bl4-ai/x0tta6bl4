# SPIRE Server Configuration
# Production-ready configuration for x0tta6bl4 mesh

server {
    # Trust domain - must match across all SPIRE components
    trust_domain = "x0tta6bl4.mesh"
    
    # Data directory for persistent state
    data_dir = "/run/spire/data"
    
    # Log level (debug, info, warn, error)
    log_level = "info"
    
    # Bind address for gRPC API
    bind_address = "0.0.0.0"
    bind_port = "8081"
    
    # Registration API (for creating entries)
    registration_uds_path = "/run/spire/sockets/registration.sock"
    
    # Default SVID TTL (1 hour)
    default_svid_ttl = "1h"
    
    # CA subject for generated certificates
    ca_subject = {
        country = ["NL"],
        organization = ["x0tta6bl4"],
        common_name = "x0tta6bl4.mesh",
    }
}

# Plugins configuration
plugins {
    # Data store - SQLite for development, PostgreSQL for production
    DataStore "sql" {
        plugin_data {
            database_type = "sqlite3"
            connection_string = "/run/spire/data/datastore.sqlite3"
        }
    }

    # Key manager - disk for development, AWS KMS/GCP KMS for production
    KeyManager "disk" {
        plugin_data {
            keys_path = "/run/spire/data/keys.json"
        }
    }

    # Node attestation - join token for development, AWS IID/GCP IID for production
    NodeAttestor "join_token" {
        plugin_data {
            join_token_ttl = "1h"
        }
    }

    # Workload attestation - Unix for containers, Kubernetes for K8s
    WorkloadAttestor "unix" {
        plugin_data {
            discover_workload_path = true
            workload_size_limit_kb = 100
        }
    }

    # Bundle publisher - for distributing trust bundles
    BundlePublisher "disk" {
        plugin_data {
            bundle_path = "/run/spire/data/bundle.der"
        }
    }
}

# Health checks
health_checks {
    listener_enabled = true
    bind_address = "0.0.0.0"
    bind_port = "8080"
}
