# SPIRE Agent Configuration
# Production-ready configuration for x0tta6bl4 mesh

agent {
    # Trust domain - must match SPIRE Server
    trust_domain = "x0tta6bl4.mesh"
    
    # Data directory
    data_dir = "/run/spire/data"
    
    # Log level
    log_level = "info"
    
    # Server address (SPIRE Server gRPC endpoint)
    server_address = "spire-server"
    server_port = "8081"
    
    # Socket path for Workload API
    socket_path = "/run/spire/sockets/agent.sock"
    
    # Trust bundle path (obtained from server)
    trust_bundle_path = "/run/spire/data/bundle.der"
    
    # Join token for initial attestation (set via environment)
    # join_token = ""
}

# Plugins configuration
plugins {
    # Node attestation - join token for development
    NodeAttestor "join_token" {
        plugin_data {
            # Token will be provided via environment or command line
        }
    }

    # Workload attestation - Unix for containers
    WorkloadAttestor "unix" {
        plugin_data {
            # Discover workload from process info
            discover_workload_path = true
            workload_size_limit_kb = 100
        }
    }

    # Kubernetes workload attestation (for K8s deployment)
    WorkloadAttestor "k8s" {
        plugin_data {
            # Disable for Docker Compose, enable for Kubernetes
            enabled = false
        }
    }

    # Docker workload attestation
    WorkloadAttestor "docker" {
        plugin_data {
            # Docker socket for container metadata
            docker_socket = "/var/run/docker.sock"
        }
    }
}

# Health checks
health_checks {
    listener_enabled = true
    bind_address = "0.0.0.0"
    bind_port = "8080"
}
