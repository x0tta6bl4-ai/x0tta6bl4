version: '3.8'

services:
  # 0. SSL Reverse Proxy (Caddy)
  caddy:
    image: caddy:alpine
    container_name: x0tta6bl4-caddy
    restart: always
    network_mode: host
    environment:
      - DOMAIN=localhost
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - landing
      - api
      - xray

  # 1. Landing Page (Frontend)
  landing:
    build:
      context: .
      dockerfile: Dockerfile.landing
    container_name: x0tta6bl4-landing
    restart: always
    ports:
      - "127.0.0.1:8081:80"

  # 2. API Backend
  api:
    build:
      context: .
      dockerfile: Dockerfile.app
    container_name: x0tta6bl4-api
    restart: always
    network_mode: host
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=x0tta6bl4
      - DATABASE_URL=sqlite:///./data/sql_app.db
    command: uvicorn src.core.app:app --host 0.0.0.0 --port 8080
    volumes:
      - ./xray_main_config.json:/etc/xray/config.json
      - /var/run/docker.sock:/var/run/docker.sock
      - sqlite_data:/app/data

  # 3. System Orchestrator (MVP Logic: Consciousness, Swarm, Loops)
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile.app
    container_name: x0tta6bl4-orchestrator
    network_mode: host
    restart: always
    environment:
      - MVP_MODE=docker
      - XRAY_HOST=localhost
      - XRAY_PORT=10808
      - LOG_LEVEL=INFO
      - DATABASE_URL=sqlite:///./data/sql_app.db
    command: python scripts/launch_mvp.py
    volumes:
      - sqlite_data:/app/data
    depends_on:
      - api
      - xray

  # 4. VPN Core (Xray)
  xray:
    image: teddysun/xray:latest
    container_name: x0tta6bl4-xray
    restart: always
    network_mode: host
    volumes:
      - ./xray_main_config.json:/etc/xray/config.json
      - ./logs/xray:/var/log/xray

  # 5. Monitoring (Prometheus)
  prometheus:
    image: prom/prometheus:latest
    container_name: x0tta6bl4-prometheus
    restart: always
    network_mode: host
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus

  # 6. Monitoring (Grafana)
  grafana:
    image: grafana/grafana:latest
    container_name: x0tta6bl4-grafana
    restart: always
    network_mode: host
    volumes:
      - grafana_data:/var/lib/grafana

  # 7. Telegram Sales Bot
  telegram_bot:
    build:
      context: .
      dockerfile: Dockerfile.app
    container_name: x0tta6bl4-bot
    restart: always
    network_mode: host
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - USDT_TRC20_WALLET=${USDT_TRC20_WALLET}
      - TON_WALLET=${TON_WALLET}
      - TRON_API_KEY=${TRON_API_KEY}
      - TON_API_KEY=${TON_API_KEY}
      - DOWNLOAD_URL=${DOWNLOAD_URL:-https://x0tta6bl4.com/download}
      - DATABASE_URL=sqlite:///./data/sql_app.db
    command: python -m src.sales.telegram_bot
    volumes:
      - ./xray_main_config.json:/etc/xray/config.json
      - /var/run/docker.sock:/var/run/docker.sock
      - sqlite_data:/app/data
    depends_on:
      - api
      - xray

volumes:
  prometheus_data:
  grafana_data:
  caddy_data:
  caddy_config:
  sqlite_data:
