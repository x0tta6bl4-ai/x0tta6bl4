name: Deploy x0tta6bl4 Mesh

on:
  workflow_dispatch:
    inputs:
      target_environment:
        description: "Deployment target"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production

jobs:
  preflight:
    name: Preflight Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Validate deployment flags
        run: |
          set -euo pipefail
          echo "Target: ${{ github.event.inputs.target_environment }}"
          if [ "${{ vars.ENABLE_MESH_DEPLOY || 'false' }}" != "true" ]; then
            echo "Mesh deploy is disabled (ENABLE_MESH_DEPLOY != true)."
            echo "Enable repository variable ENABLE_MESH_DEPLOY=true to run real deployment."
            exit 0
          fi
          echo "Mesh deploy flag is enabled."

  deploy:
    name: Deploy
    needs: preflight
    if: vars.ENABLE_MESH_DEPLOY == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Execute deployment script
        env:
          VPS_IP: ${{ secrets.VPS_IP }}
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
        run: |
          set -euo pipefail
          if [ -z "${VPS_IP}" ] || [ -z "${VAULT_TOKEN}" ]; then
            echo "Missing required secrets VPS_IP or VAULT_TOKEN."
            exit 1
          fi
          bash ./deploy.sh --mode "${{ github.event.inputs.target_environment }}" --target "vps:${VPS_IP}" --vault-token "${VAULT_TOKEN}"
