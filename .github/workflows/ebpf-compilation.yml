name: eBPF Compilation & Integration

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/network/ebpf/programs/**'
      - '.github/workflows/ebpf-compilation.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/network/ebpf/programs/**'

env:
  LLVM_VERSION: 14
  BPF_HEADERS_VERSION: 6.0

jobs:
  # Job 1: Compile eBPF programs to .o files
  compile:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            llvm-${{ env.LLVM_VERSION }} \
            clang-${{ env.LLVM_VERSION }} \
            libelf-dev \
            libz-dev \
            pkg-config \
            linux-headers-$(uname -r)
      
      - name: Create build directory
        run: |
          mkdir -p build/ebpf
          mkdir -p artifacts
      
      - name: Compile XDP programs
        working-directory: src/network/ebpf/programs
        run: |
          # Compile XDP counter
          clang-${{ env.LLVM_VERSION }} \
            -S -target bpf \
            -D__KERNEL__ -D__BPF_TRACING__ \
            -O2 \
            -c xdp_counter.c \
            -o xdp_counter.ll
          
          llc-${{ env.LLVM_VERSION }} \
            -march=bpf \
            -filetype=obj \
            -o ../../../build/ebpf/xdp_counter.o \
            xdp_counter.ll
          
          # Compile XDP mesh filter
          clang-${{ env.LLVM_VERSION }} \
            -S -target bpf \
            -D__KERNEL__ -D__BPF_TRACING__ \
            -O2 \
            -c xdp_mesh_filter.c \
            -o xdp_mesh_filter.ll
          
          llc-${{ env.LLVM_VERSION }} \
            -march=bpf \
            -filetype=obj \
            -o ../../../build/ebpf/xdp_mesh_filter.o \
            xdp_mesh_filter.ll
          
          # Compile XDP PQC verify
          clang-${{ env.LLVM_VERSION }} \
            -S -target bpf \
            -D__KERNEL__ -D__BPF_TRACING__ \
            -O2 \
            -c xdp_pqc_verify.c \
            -o xdp_pqc_verify.ll
          
          llc-${{ env.LLVM_VERSION }} \
            -march=bpf \
            -filetype=obj \
            -o ../../../build/ebpf/xdp_pqc_verify.o \
            xdp_pqc_verify.ll
          
          echo "✓ XDP programs compiled"
      
      - name: Compile kprobe programs
        working-directory: src/network/ebpf/programs
        run: |
          # Compile kprobe syscall latency
          clang-${{ env.LLVM_VERSION }} \
            -S -target bpf \
            -D__KERNEL__ -D__BPF_TRACING__ \
            -O2 \
            -c kprobe_syscall_latency_secure.c \
            -o kprobe_syscall_latency.ll
          
          llc-${{ env.LLVM_VERSION }} \
            -march=bpf \
            -filetype=obj \
            -o ../../../build/ebpf/kprobe_syscall_latency.o \
            kprobe_syscall_latency.ll
          
          echo "✓ kprobe programs compiled"
      
      - name: Compile tracepoint programs
        working-directory: src/network/ebpf/programs
        run: |
          # Compile tracepoint net events
          clang-${{ env.LLVM_VERSION }} \
            -S -target bpf \
            -D__KERNEL__ -D__BPF_TRACING__ \
            -O2 \
            -c tracepoint_net.c \
            -o tracepoint_net.ll
          
          llc-${{ env.LLVM_VERSION }} \
            -march=bpf \
            -filetype=obj \
            -o ../../../build/ebpf/tracepoint_net.o \
            tracepoint_net.ll
          
          echo "✓ tracepoint programs compiled"
      
      - name: Compile TC programs
        working-directory: src/network/ebpf/programs
        run: |
          # Compile TC classifier
          clang-${{ env.LLVM_VERSION }} \
            -S -target bpf \
            -D__KERNEL__ -D__BPF_TRACING__ \
            -O2 \
            -c tc_classifier.c \
            -o tc_classifier.ll
          
          llc-${{ env.LLVM_VERSION }} \
            -march=bpf \
            -filetype=obj \
            -o ../../../build/ebpf/tc_classifier.o \
            tc_classifier.ll
          
          echo "✓ TC programs compiled"
      
      - name: Verify compiled objects
        run: |
          echo "Compiled eBPF programs:"
          ls -lah build/ebpf/*.o
          
          # Check ELF headers
          file build/ebpf/*.o
          
          # Verify all .o files are valid eBPF
          for obj in build/ebpf/*.o; do
            readelf -h "$obj" | grep -q "Machine.*BPF" && \
              echo "✓ $(basename $obj) is valid eBPF" || \
              (echo "✗ $(basename $obj) is INVALID" && exit 1)
          done
      
      - name: Upload compiled artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ebpf-objects
          path: build/ebpf/
          retention-days: 5
  
  # Job 2: Validate eBPF programs
  validate:
    runs-on: ubuntu-latest
    needs: compile
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            llvm-${{ env.LLVM_VERSION }} \
            clang-${{ env.LLVM_VERSION }} \
            libelf-dev \
            bpftool
      
      - name: Download compiled artifacts
        uses: actions/download-artifact@v3
        with:
          name: ebpf-objects
          path: build/ebpf/
      
      - name: Validate eBPF programs with verifier
        run: |
          echo "Validating eBPF programs..."
          
          # Use kernel's eBPF verifier (requires root in container)
          # bpftool prog load build/ebpf/xdp_counter.o type xdp \
          #   pinned /sys/fs/bpf/xdp_counter
          
          # For now, use static analysis
          for obj in build/ebpf/*.o; do
            echo "Analyzing $(basename $obj)..."
            llvm-objdump-${{ env.LLVM_VERSION }} -d "$obj" | head -20
          done
      
      - name: Check program sections
        run: |
          echo "Checking eBPF sections:"
          for obj in build/ebpf/*.o; do
            echo "--- $(basename $obj) ---"
            objdump -h "$obj" | grep -E "\.bss|\.rodata|\.text|\.maps"
          done
  
  # Job 3: Test Python loader integration
  test-loader:
    runs-on: ubuntu-latest
    needs: compile
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install pytest pytest-cov pyelftools
          
          # Install core dependencies
          pip install -r requirements-core.txt 2>/dev/null || true
      
      - name: Download compiled artifacts
        uses: actions/download-artifact@v3
        with:
          name: ebpf-objects
          path: build/ebpf/
      
      - name: Copy artifacts to src/network/ebpf
        run: |
          cp build/ebpf/*.o src/network/ebpf/
      
      - name: Test eBPF loader
        run: |
          python -m pytest tests/test_ebpf_loader.py -v --tb=short
      
      - name: Test eBPF orchestrator
        run: |
          python -m pytest tests/test_ebpf_orchestrator.py -v --tb=short
  
  # Job 4: Create releases with compiled objects
  package:
    runs-on: ubuntu-latest
    needs: [ compile, validate, test-loader ]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download compiled artifacts
        uses: actions/download-artifact@v3
        with:
          name: ebpf-objects
          path: build/ebpf/
      
      - name: Create release package
        run: |
          mkdir -p release/ebpf
          cp build/ebpf/*.o release/ebpf/
          
          # Create manifest
          cat > release/MANIFEST.txt << 'EOF'
          # eBPF Programs Manifest
          
          Compiled eBPF Programs (Linux kernel eBPF bytecode)
          
          Programs:
          - xdp_counter.o: XDP packet counter
          - xdp_mesh_filter.o: XDP mesh packet filtering
          - xdp_pqc_verify.o: XDP post-quantum crypto verification
          - kprobe_syscall_latency.o: System call latency tracing
          - tracepoint_net.o: Network tracepoint monitoring
          - tc_classifier.o: Traffic control classifier
          
          Load with:
            from src.network.ebpf.loader import EBPFLoader
            loader = EBPFLoader()
            loader.load_program('xdp_counter.o', 'xdp')
          EOF
          
          tar -czf x0tta6bl4-ebpf-${{ github.sha }}.tar.gz -C release .
      
      - name: Upload to release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: x0tta6bl4-ebpf-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Copy to artifacts directory
        run: |
          mkdir -p src/network/ebpf
          cp build/ebpf/*.o src/network/ebpf/
          
          git config user.email "ci@x0tta6bl4.local"
          git config user.name "CI Bot"
          git add -f src/network/ebpf/*.o 2>/dev/null || true
          git commit -m "ci: compile eBPF programs [skip ci]" || true
      
      - name: Push compiled objects
        if: github.event_name == 'push'
        run: |
          git push --quiet || true

# Notifications
  notify:
    runs-on: ubuntu-latest
    needs: [ compile, validate, test-loader ]
    if: always()
    
    steps:
      - name: Print summary
        run: |
          echo "## eBPF Compilation Pipeline"
          echo "✓ Compilation: ${{ needs.compile.result }}"
          echo "✓ Validation: ${{ needs.validate.result }}"
          echo "✓ Loader Tests: ${{ needs.test-loader.result }}"
          echo ""
          echo "Artifacts: ebpf-objects (available for 5 days)"
