name: eBPF Programs Compilation & Testing

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/network/ebpf/programs/**'
      - 'src/network/ebpf/**'
      - '.github/workflows/ebpf-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/network/ebpf/programs/**'
      - 'src/network/ebpf/**'

jobs:
  ebpf-build:
    name: Build eBPF Programs
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        kernel-version: ['5.15', '6.0', '6.5']
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang \
            llvm \
            linux-headers-generic \
            libbpf-dev \
            libelf-dev \
            build-essential
      
      - name: Verify kernel version
        run: |
          uname -r
          echo "Kernel headers: $(dpkg -l | grep linux-headers)"
      
      - name: Setup build environment
        run: |
          mkdir -p build/ebpf
          echo "CLANG=$(which clang)" >> $GITHUB_ENV
          echo "LLC=$(which llc)" >> $GITHUB_ENV
      
      - name: Compile eBPF programs
        working-directory: src/network/ebpf/programs
        run: |
          make clean
          make all
          echo "✅ eBPF compilation successful"
      
      - name: List compiled objects
        working-directory: src/network/ebpf/programs
        run: |
          echo "Compiled eBPF objects:"
          ls -lh *.o
      
      - name: Verify object files
        working-directory: src/network/ebpf/programs
        run: |
          for obj in *.o; do
            echo "Checking $obj..."
            llvm-objdump -d $obj | head -5
            file $obj
          done
      
      - name: Store compiled objects
        uses: actions/upload-artifact@v4
        with:
          name: ebpf-objects-${{ matrix.kernel-version }}
          path: src/network/ebpf/programs/*.o
          retention-days: 7
  
  ebpf-test:
    name: eBPF Integration Tests
    runs-on: ubuntu-latest
    needs: ebpf-build
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[ml,dev,monitoring]
      
      - name: Download eBPF objects
        uses: actions/download-artifact@v4
        with:
          name: ebpf-objects-5.15
          path: src/network/ebpf/programs/
      
      - name: Install runtime dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libbpf0 \
            libelf1 \
            clang-tools
      
      - name: Run eBPF loader unit tests
        run: |
          pytest tests/network/ebpf/test_ebpf_loader.py -v -m unit
      
      - name: Run eBPF integration tests
        continue-on-error: true
        run: |
          pytest tests/network/ebpf/test_ebpf_integration.py -v -m integration
      
      - name: Check eBPF-MAPE-K integration
        continue-on-error: true
        run: |
          pytest tests/network/ebpf/test_ebpf_mapek_integration.py -v
      
      - name: Generate coverage report
        run: |
          pytest tests/network/ebpf/ \
            --cov=src/network/ebpf \
            --cov-report=xml \
            --cov-report=term
        continue-on-error: true
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: ebpf
          fail_ci_if_error: false

  security-scan:
    name: Security Scan eBPF Code
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install security tools
        run: |
          pip install bandit safety pip-audit
      
      - name: Scan Python code for security issues
        run: |
          set -euo pipefail
          bandit -r src/network/ebpf/ -lll -iii -f json -o bandit-report.json
          cat bandit-report.json
      
      - name: Check dependencies for vulnerabilities
        run: |
          set -euo pipefail
          safety check -r requirements.txt --json > safety-report.json
          pip-audit -r requirements.txt --format json > pip-audit-report.json
      
      - name: Scan C code with cppcheck
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y cppcheck
          cppcheck \
            --enable=all \
            --suppress=missingInclude \
            --suppress=missingIncludeSystem \
            --suppress=unknownMacro \
            --error-exitcode=1 \
            src/network/ebpf/programs/*.c
      
      - name: Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
            pip-audit-report.json
          retention-days: 7

  performance-benchmark:
    name: eBPF Performance Benchmark
    runs-on: ubuntu-latest
    needs: ebpf-build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -e .[ml,dev,monitoring]
          sudo apt-get update
          sudo apt-get install -y libbpf0 libelf1
      
      - name: Download eBPF objects
        uses: actions/download-artifact@v4
        with:
          name: ebpf-objects-5.15
          path: src/network/ebpf/programs/
      
      - name: Run performance benchmarks
        run: |
          pytest tests/network/ebpf/test_ebpf_performance.py -v --benchmark-only
        continue-on-error: true
      
      - name: Compare with baseline
        run: |
          pytest tests/network/ebpf/test_ebpf_performance.py -v --benchmark-compare
        continue-on-error: true
      
      - name: Store benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: .benchmarks/
          retention-days: 30

  docker-build:
    name: Build Docker Image with eBPF
    runs-on: ubuntu-latest
    needs: ebpf-build
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download eBPF objects
        uses: actions/download-artifact@v4
        with:
          name: ebpf-objects-5.15
          path: src/network/ebpf/programs/
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Build Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile.ebpf
          push: false
          tags: x0tta6bl4:ebpf-latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [ebpf-build, ebpf-test, security-scan]
    if: always()
    
    steps:
      - name: Check build status
        if: needs.ebpf-build.result != 'success'
        run: |
          echo "❌ eBPF build failed"
          exit 1
      
      - name: Check test status
        if: needs.ebpf-test.result == 'failure'
        run: |
          echo "❌ eBPF tests failed"
          exit 1
      
      - name: Check security scan status
        if: needs.security-scan.result != 'success'
        run: |
          echo "❌ Security scan reported issues"
          exit 1
      
      - name: ✅ All checks passed
        run: echo "✅ eBPF quality gate passed"
