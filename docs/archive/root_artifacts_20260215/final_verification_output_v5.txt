============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-8.4.2, pluggy-1.6.0 -- /usr/bin/python3
cachedir: .pytest_cache
benchmark: 5.1.0 (defaults: timer=time.perf_counter disable_gc=False min_rounds=5 min_time=0.000005 max_time=1.0 calibration_precision=10 warmup=False warmup_iterations=100000)
hypothesis profile 'default' -> database=DirectoryBasedExampleDatabase(PosixPath('/mnt/projects/.hypothesis/examples'))
rootdir: /mnt/projects
configfile: pyproject.toml
plugins: asyncio-1.2.0, cov-7.0.0, xdist-3.8.0, anyio-4.12.0, mock-3.12.0, benchmark-5.1.0, hypothesis-6.98.15
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 26 items

tests/test_ebpf_integration.py::TestEBPFIntegration::test_loader_orchestrator_integration FAILED [  3%]
tests/test_ebpf_integration.py::TestEBPFIntegration::test_orchestrator_lifecycle_management PASSED [  7%]
tests/test_ebpf_integration.py::TestEBPFIntegration::test_cli_loader_integration PASSED [ 11%]
tests/test_ebpf_integration.py::TestEBPFIntegration::test_full_system_integration FAILED [ 15%]
tests/test_ebpf_integration.py::TestEBPFIntegration::test_error_handling_integration FAILED [ 19%]
tests/test_ebpf_integration.py::TestEBPFIntegration::test_performance_monitoring_integration FAILED [ 23%]
tests/test_ebpf_integration.py::TestEBPFIntegration::test_configuration_persistence PASSED [ 26%]
tests/test_pqc_integration.py::TestEBPFPQCGateway::test_create_session PASSED [ 30%]
tests/test_pqc_integration.py::TestEBPFPQCGateway::test_get_session PASSED [ 34%]
tests/test_pqc_integration.py::TestEBPFPQCGateway::test_rotate_session_keys PASSED [ 38%]
tests/test_pqc_integration.py::TestEBPFPQCGateway::test_encrypt_decrypt_payload PASSED [ 42%]
tests/test_pqc_integration.py::TestEBPFPQCGateway::test_get_ebpf_map_data PASSED [ 46%]
tests/test_pqc_integration.py::TestPQCXDPLoader::test_loader_initialization PASSED [ 50%]
tests/test_pqc_integration.py::TestPQCXDPLoader::test_update_pqc_sessions PASSED [ 53%]
tests/test_pqc_integration.py::TestPQCXDPLoader::test_get_pqc_stats PASSED [ 57%]
tests/test_pqc_integration.py::TestPQCZeroTrustHealer::test_monitor_healthy_system PASSED [ 61%]
tests/test_pqc_integration.py::TestPQCZeroTrustHealer::test_analyze_no_issues PASSED [ 65%]
tests/test_pqc_integration.py::TestPQCZeroTrustHealer::test_plan_no_action PASSED [ 69%]
tests/test_pqc_integration.py::TestPQCZeroTrustHealer::test_execute_empty_plan PASSED [ 73%]
tests/test_pqc_integration.py::TestPQCZeroTrustHealer::test_anomaly_detection FAILED [ 76%]
tests/test_pqc_integration.py::TestPQCZeroTrustHealer::test_health_score_calculation PASSED [ 80%]
tests/test_pqc_integration.py::TestPQCZeroTrustHealer::test_cleanup_expired_sessions FAILED [ 84%]
tests/test_pqc_integration.py::TestPQCZeroTrustHealer::test_rotate_expired_sessions FAILED [ 88%]
tests/test_pqc_integration.py::TestPQCSessionAnomaly::test_anomaly_creation PASSED [ 92%]
tests/test_pqc_integration.py::TestIntegration::test_full_healing_cycle PASSED [ 96%]
tests/test_pqc_integration.py::TestIntegration::test_gateway_loader_integration PASSED [100%]/home/x0ttta6bl4/.local/lib/python3.12/site-packages/coverage/report_core.py:107: CoverageWarning: Couldn't parse Python file '/mnt/projects/src/network/обновление_алгоритмов.py' (couldnt-parse); see https://coverage.readthedocs.io/en/7.13.0/messages.html#warning-couldnt-parse
  coverage._warn(msg, slug="couldnt-parse")

ERROR: Coverage failure: total of 4 is less than fail-under=75


=================================== FAILURES ===================================
___________ TestEBPFIntegration.test_loader_orchestrator_integration ___________
tests/test_ebpf_integration.py:105: in test_loader_orchestrator_integration
    programs = orchestrator.list_programs()
               ^^^^^^^^^^^^^^^^^^^^^^^^^^
E   AttributeError: 'EBPFOrchestrator' object has no attribute 'list_programs'. Did you mean: '_load_programs'?
----------------------------- Captured stderr call -----------------------------
In file included from /virtual/main.c:2:
In file included from include/uapi/linux/ptrace.h:183:
In file included from arch/x86/include/asm/ptrace.h:175:
In file included from arch/x86/include/asm/paravirt_types.h:12:
In file included from arch/x86/include/asm/nospec-branch.h:15:
arch/x86/include/asm/current.h:47:10: warning: multiple identical address spaces specified for type [-Wduplicate-decl-specifier]
   47 |                 return this_cpu_read_const(const_pcpu_hot.current_task);
      |                        ^
arch/x86/include/asm/percpu.h:578:36: note: expanded from macro 'this_cpu_read_const'
  578 | #define this_cpu_read_const(pcp)                        __raw_cpu_read_const(pcp)
      |                                                         ^
arch/x86/include/asm/percpu.h:163:35: note: expanded from macro '__raw_cpu_read_const'
  163 | #define __raw_cpu_read_const(pcp)       __raw_cpu_read(, , pcp)
      |                                         ^
arch/x86/include/asm/percpu.h:155:30: note: expanded from macro '__raw_cpu_read'
  155 |         *(qual __my_cpu_type(pcp) *)__my_cpu_ptr(&(pcp));               \
      |                                     ^
note: (skipping 1 expansions in backtrace; use -fmacro-backtrace-limit=0 to see all)
arch/x86/include/asm/percpu.h:94:40: note: expanded from macro '__my_cpu_type'
   94 | #define __my_cpu_type(var)      typeof(var) __percpu_seg_override
      |                                             ^
arch/x86/include/asm/percpu.h:45:32: note: expanded from macro '__percpu_seg_override'
   45 | # define __percpu_seg_override  __seg_gs
      |                                 ^
<built-in>:358:33: note: expanded from macro '__seg_gs'
  358 | #define __seg_gs __attribute__((address_space(256)))
      |                                 ^
In file included from /virtual/main.c:2:
In file included from include/uapi/linux/ptrace.h:183:
In file included from arch/x86/include/asm/ptrace.h:175:
In file included from arch/x86/include/asm/paravirt_types.h:12:
In file included from arch/x86/include/asm/nospec-branch.h:15:
arch/x86/include/asm/current.h:47:10: warning: multiple identical address spaces specified for type [-Wduplicate-decl-specifier]
arch/x86/include/asm/percpu.h:578:36: note: expanded from macro 'this_cpu_read_const'
  578 | #define this_cpu_read_const(pcp)                        __raw_cpu_read_const(pcp)
      |                                                         ^
arch/x86/include/asm/percpu.h:163:35: note: expanded from macro '__raw_cpu_read_const'
  163 | #define __raw_cpu_read_const(pcp)       __raw_cpu_read(, , pcp)
      |                                         ^
arch/x86/include/asm/percpu.h:155:9: note: expanded from macro '__raw_cpu_read'
  155 |         *(qual __my_cpu_type(pcp) *)__my_cpu_ptr(&(pcp));               \
      |                ^
arch/x86/include/asm/percpu.h:94:40: note: expanded from macro '__my_cpu_type'
   94 | #define __my_cpu_type(var)      typeof(var) __percpu_seg_override
      |                                             ^
arch/x86/include/asm/percpu.h:45:32: note: expanded from macro '__percpu_seg_override'
   45 | # define __percpu_seg_override  __seg_gs
      |                                 ^
<built-in>:358:33: note: expanded from macro '__seg_gs'
  358 | #define __seg_gs __attribute__((address_space(256)))
      |                                 ^
In file included from /virtual/main.c:3:
In file included from include/linux/netdevice.h:24:
In file included from include/linux/timer.h:6:
In file included from include/linux/ktime.h:25:
In file included from include/linux/jiffies.h:10:
In file included from include/linux/time.h:60:
In file included from include/linux/time32.h:13:
In file included from include/linux/timex.h:67:
In file included from arch/x86/include/asm/timex.h:5:
arch/x86/include/asm/processor.h:564:10: warning: multiple identical address spaces specified for type [-Wduplicate-decl-specifier]
  564 |                 return this_cpu_read_const(const_pcpu_hot.top_of_stack);
      |                        ^
arch/x86/include/asm/percpu.h:578:36: note: expanded from macro 'this_cpu_read_const'
  578 | #define this_cpu_read_const(pcp)                        __raw_cpu_read_const(pcp)
      |                                                         ^
arch/x86/include/asm/percpu.h:163:35: note: expanded from macro '__raw_cpu_read_const'
  163 | #define __raw_cpu_read_const(pcp)       __raw_cpu_read(, , pcp)
      |                                         ^
arch/x86/include/asm/percpu.h:155:30: note: expanded from macro '__raw_cpu_read'
  155 |         *(qual __my_cpu_type(pcp) *)__my_cpu_ptr(&(pcp));               \
      |                                     ^
note: (skipping 1 expansions in backtrace; use -fmacro-backtrace-limit=0 to see all)
arch/x86/include/asm/percpu.h:94:40: note: expanded from macro '__my_cpu_type'
   94 | #define __my_cpu_type(var)      typeof(var) __percpu_seg_override
      |                                             ^
arch/x86/include/asm/percpu.h:45:32: note: expanded from macro '__percpu_seg_override'
   45 | # define __percpu_seg_override  __seg_gs
      |                                 ^
<built-in>:358:33: note: expanded from macro '__seg_gs'
  358 | #define __seg_gs __attribute__((address_space(256)))
      |                                 ^
In file included from /virtual/main.c:3:
In file included from include/linux/netdevice.h:24:
In file included from include/linux/timer.h:6:
In file included from include/linux/ktime.h:25:
In file included from include/linux/jiffies.h:10:
In file included from include/linux/time.h:60:
In file included from include/linux/time32.h:13:
In file included from include/linux/timex.h:67:
In file included from arch/x86/include/asm/timex.h:5:
arch/x86/include/asm/processor.h:564:10: warning: multiple identical address spaces specified for type [-Wduplicate-decl-specifier]
arch/x86/include/asm/percpu.h:578:36: note: expanded from macro 'this_cpu_read_const'
  578 | #define this_cpu_read_const(pcp)                        __raw_cpu_read_const(pcp)
      |                                                         ^
arch/x86/include/asm/percpu.h:163:35: note: expanded from macro '__raw_cpu_read_const'
  163 | #define __raw_cpu_read_const(pcp)       __raw_cpu_read(, , pcp)
      |                                         ^
arch/x86/include/asm/percpu.h:155:9: note: expanded from macro '__raw_cpu_read'
  155 |         *(qual __my_cpu_type(pcp) *)__my_cpu_ptr(&(pcp));               \
      |                ^
arch/x86/include/asm/percpu.h:94:40: note: expanded from macro '__my_cpu_type'
   94 | #define __my_cpu_type(var)      typeof(var) __percpu_seg_override
      |                                             ^
arch/x86/include/asm/percpu.h:45:32: note: expanded from macro '__percpu_seg_override'
   45 | # define __percpu_seg_override  __seg_gs
      |                                 ^
<built-in>:358:33: note: expanded from macro '__seg_gs'
  358 | #define __seg_gs __attribute__((address_space(256)))
      |                                 ^
In file included from /virtual/main.c:3:
In file included from include/linux/netdevice.h:44:
In file included from include/uapi/linux/neighbour.h:6:
In file included from include/linux/netlink.h:9:
In file included from include/net/scm.h:9:
In file included from include/linux/security.h:35:
include/linux/bpf.h:352:10: error: invalid application of 'sizeof' to an incomplete type 'struct bpf_wq'
  352 |                 return sizeof(struct bpf_wq);
      |                        ^     ~~~~~~~~~~~~~~~
include/linux/bpf.h:352:24: note: forward declaration of 'struct bpf_wq'
  352 |                 return sizeof(struct bpf_wq);
      |                                      ^
include/linux/bpf.h:382:10: error: invalid application of '__alignof' to an incomplete type 'struct bpf_wq'
  382 |                 return __alignof__(struct bpf_wq);
      |                        ^          ~~~~~~~~~~~~~~~
include/linux/bpf.h:382:29: note: forward declaration of 'struct bpf_wq'
  382 |                 return __alignof__(struct bpf_wq);
      |                                           ^
/virtual/main.c:9:5: error: expected parameter declarator
    9 | SEC("tracepoint/net/netif_receive_skb")
      |     ^
/virtual/main.c:9:5: error: expected ')'
/virtual/main.c:9:4: note: to match this '('
    9 | SEC("tracepoint/net/netif_receive_skb")
      |    ^
/virtual/main.c:9:1: error: type specifier missing, defaults to 'int'; ISO C99 and later do not support implicit int [-Wimplicit-int]
    9 | SEC("tracepoint/net/netif_receive_skb")
      | ^
      | int
/virtual/main.c:9:40: error: expected ';' after top level declarator
    9 | SEC("tracepoint/net/netif_receive_skb")
      |                                        ^
      |                                        ;
/virtual/main.c:10:28: warning: declaration of 'struct trace_event_raw_netif_receive_skb' will not be visible outside of this function [-Wvisibility]
   10 | int ingress_latency(struct trace_event_raw_netif_receive_skb *ctx) {
      |                            ^
/virtual/main.c:18:5: error: expected parameter declarator
   18 | SEC("tracepoint/net/net_dev_xmit")
      |     ^
/virtual/main.c:18:5: error: expected ')'
/virtual/main.c:18:4: note: to match this '('
   18 | SEC("tracepoint/net/net_dev_xmit")
      |    ^
/virtual/main.c:18:1: error: type specifier missing, defaults to 'int'; ISO C99 and later do not support implicit int [-Wimplicit-int]
   18 | SEC("tracepoint/net/net_dev_xmit")
      | ^
      | int
/virtual/main.c:18:35: error: expected ';' after top level declarator
   18 | SEC("tracepoint/net/net_dev_xmit")
      |                                   ^
      |                                   ;
/virtual/main.c:19:27: warning: declaration of 'struct trace_event_raw_net_dev_template' will not be visible outside of this function [-Wvisibility]
   19 | int egress_latency(struct trace_event_raw_net_dev_template *ctx) {
      |                           ^
6 warnings and 10 errors generated.
------------------------------ Captured log call -------------------------------
WARNING  src.network.ebpf.orchestrator:orchestrator.py:267 ⚠️ MeshNetworkProbes initialization failed: Failed to compile BPF module <text>
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_packets_processed_total
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_packets_dropped_total
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_processing_latency_microseconds
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_cpu_usage_percent
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_memory_usage_bytes
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_flows_active
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_errors_total
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_program_load_time_seconds
_______________ TestEBPFIntegration.test_full_system_integration _______________
tests/test_ebpf_integration.py:178: in test_full_system_integration
    program_id = await orchestrator.load_program("test_xdp.o")
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: object NoneType can't be used in 'await' expression
------------------------------ Captured log call -------------------------------
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_packets_processed_total
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_packets_dropped_total
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_processing_latency_microseconds
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_cpu_usage_percent
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_memory_usage_bytes
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_flows_active
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_errors_total
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_program_load_time_seconds
ERROR    src.network.ebpf.orchestrator:orchestrator.py:586 Failed to load program: eBPF program not found: /tmp/tmp34p6fq1s/test_xdp.o
_____________ TestEBPFIntegration.test_error_handling_integration ______________
tests/test_ebpf_integration.py:209: in test_error_handling_integration
    with pytest.raises(Exception):
E   Failed: DID NOT RAISE <class 'Exception'>
_________ TestEBPFIntegration.test_performance_monitoring_integration __________
tests/test_ebpf_integration.py:229: in test_performance_monitoring_integration
    assert 'status' in health
E   assert 'status' in {'healthy': False, 'state': 'running', 'checks': {'loader': {'status': 'healthy', 'programs_loaded': 0}, 'probes': {'status': 'unhealthy', 'error': "'>' not supported between instances of 'MagicMock' and 'int'"}, 'cilium': {'status': 'healthy', 'flows_processed': <MagicMock name='CiliumLikeIntegration().get_flow_metrics().get()' id='132266306941632'>}}}
------------------------------ Captured log call -------------------------------
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_packets_processed_total
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_packets_dropped_total
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_processing_latency_microseconds
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_cpu_usage_percent
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_memory_usage_bytes
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_flows_active
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_errors_total
WARNING  src.network.ebpf.performance_monitor:performance_monitor.py:168 Prometheus not available, skipping metric: ebpf_program_load_time_seconds
________________ TestPQCZeroTrustHealer.test_anomaly_detection _________________
tests/test_pqc_integration.py:254: in test_anomaly_detection
    anomalies = self.healer.monitor._detect_anomalies(mock_sessions, mock_ebpf_stats, current_ts)
                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/self_healing/pqc_zero_trust_healer.py:141: in _detect_anomalies
    if current_ts - session.last_used > expiry_seconds:
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: unsupported operand type(s) for -: 'float' and 'datetime.datetime'
_____________ TestPQCZeroTrustHealer.test_cleanup_expired_sessions _____________
tests/test_pqc_integration.py:304: in test_cleanup_expired_sessions
    assert result['success'] is True
E   assert False is True
_____________ TestPQCZeroTrustHealer.test_rotate_expired_sessions ______________
tests/test_pqc_integration.py:321: in test_rotate_expired_sessions
    assert result['success'] is True
E   assert False is True
----------------- generated xml file: /mnt/projects/junit.xml ------------------
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.3-final-0 ________________

Coverage HTML written to dir htmlcov
Coverage XML written to file coverage.xml
FAIL Required test coverage of 75% not reached. Total coverage: 3.64%
=========================== short test summary info ============================
FAILED tests/test_ebpf_integration.py::TestEBPFIntegration::test_loader_orchestrator_integration - AttributeError: 'EBPFOrchestrator' object has no attribute 'list_programs'. Did you mean: '_load_programs'?
FAILED tests/test_ebpf_integration.py::TestEBPFIntegration::test_full_system_integration - TypeError: object NoneType can't be used in 'await' expression
FAILED tests/test_ebpf_integration.py::TestEBPFIntegration::test_error_handling_integration - Failed: DID NOT RAISE <class 'Exception'>
FAILED tests/test_ebpf_integration.py::TestEBPFIntegration::test_performance_monitoring_integration - assert 'status' in {'healthy': False, 'state': 'running', 'checks': {'loader': {'status': 'healthy', 'programs_loaded': 0}, 'probes': {'status': 'unhealthy', 'error': "'>' not supported between instances of 'MagicMock' and 'int'"}, 'cilium': {'status': 'healthy', 'flows_processed': <MagicMock name='CiliumLikeIntegration().get_flow_metrics().get()' id='132266306941632'>}}}
FAILED tests/test_pqc_integration.py::TestPQCZeroTrustHealer::test_anomaly_detection - TypeError: unsupported operand type(s) for -: 'float' and 'datetime.datetime'
FAILED tests/test_pqc_integration.py::TestPQCZeroTrustHealer::test_cleanup_expired_sessions - assert False is True
FAILED tests/test_pqc_integration.py::TestPQCZeroTrustHealer::test_rotate_expired_sessions - assert False is True
======================== 7 failed, 19 passed in 47.11s =========================
