# AI Agent Workflow - MaaS x0tta6bl4

## Обзор

Этот документ определяет роли агентов в разработке MaaS x0tta6bl4 и конвейер работы для предотвращения хаоса и дублирования.

---

## Роли агентов

### 1. Gemini 3 — Архитектор и аналитик

**Роль**: Старший инженер, проектировщик

**Зоны ответственности**:
- Проработка архитектуры фич: модули, интерфейсы, границы
- Декомпозиция задач: чек-листы, шаги для Codex/Claude/GLM
- Проработка контрактов: сигнатуры функций, схемы Pydantic, форматы событий
- Высокоуровневые алгоритмы: self-healing, Swarm-логика, MAPE-K-петли

**Файловые зоны**:
```
plans/           # Дизайн-документы
docs/adr/        # Architecture Decision Records
docs/*.md        # Техническая документация
```

**Ограничения**:
- ❌ НЕ трогает существующий код
- ❌ НЕ меняет конфигурацию
- ✅ Выдаёт дизайн/псевдокод и TODO-пункты

**Пример промпта**:
```
Спроектируй архитектуру для [фича]. 
Выдай:
1. Список модулей и их границы
2. Интерфейсы (Pydantic схемы)
3. TODO-пункты для реализации
НЕ изменяй существующий код.
```

---

### 2. Codex — Исполнитель кода

**Роль**: Главный кодер

**Зоны ответственности**:
- Реализация по ТЗ от Gemini
- Новые эндпоинты, модели, middleware, сервисы
- Заполнение тестов по сценариям
- Механическая работа: миграции, однотипные функции, wiring

**Файловые зоны**:
```
src/             # Весь исходный код
tests/           # Тесты
alembic/         # Миграции БД
```

**Ограничения**:
- ❌ НЕ меняет архитектуру самостоятельно
- ❌ НЕ трогает конфиги/roadmap/STATUS
- ✅ Реализует только описанное поведение

**Пример промпта**:
```
Реализуй [endpoint/функция] по ТЗ:
[вставить ТЗ от Gemini]

Требования:
- Только указанное поведение
- Не менять другие функции
- Добавить юнит-тесты
```

---

### 3. Claude Code — Ревьюер и старший по качеству

**Роль**: Code review, рефакторинг, качество

**Зоны ответственности**:
- Просмотр диффов: баги, edge-кейсы
- Рефакторинг: разбиение god-objects, нейминг, докстринги
- Подсказки по тестам: недостающие кейсы
- Архитектурные риски: жёсткие связки, Zero-Trust нарушения, race conditions

**Файловые зоны**:
```
src/             # Точечные правки
tests/           # Дополнение тестов
docs/            # Документация API
```

**Ограничения**:
- ❌ НЕ генерирует новый код с нуля
- ✅ Только ревьюит и точечно дополняет

**Пример промпта**:
```
Сделай code review для [файл/дифф]:
- Найди баги и потенциальные проблемы
- Предложи улучшения читаемости
- Укажи недостающие тест-кейсы
- Предложи микрорефакторинг без смены поведения
```

---

### 4. GLM-5 (Kilo Code) — Генератор альтернатив и стресс-тестер

**Роль**: R&D-мозг, вариативность, эксперименты

**Зоны ответственности**:
- Альтернативные алгоритмы (другая стратегия маршрутизации/кеширования)
- Расширенные тест-кейсы: большие таблицы входов/выходов
- Производительность: идеи оптимизации, профилировочные гипотезы
- Локализация и интеграция с азиатским/опенсорс-стеком

**Файловые зоны**:
```
experiments/     # R&D эксперименты
tests/load/      # Нагрузочные тесты
benchmarks/      # Бенчмарки
docs/perf/       # Отчёты по производительности
```

**Ограничения**:
- ❌ НЕ правит боевой код без ревью Claude
- ✅ Работает в отдельных ветках/директориях

**Пример промпта**:
```
Для реализации [функция] предложи:
1. 3 альтернативных алгоритма
2. Edge-кейсы для тестирования
3. Идеи оптимизации производительности
4. Нагрузочный сценарий для валидации
```

---

### 5. Perplexity — Внешний R&D и продукт/рынок

**Роль**: Мета-уровень, внешний контекст

**Зоны ответственности**:
- Анализ рынка, конкурентов (Tailscale, Netmaker, SASE-вендоры)
- Проверка идей на бизнес-реалистичность
- Roadmap, тексты для грантов, лендинга, демо-сценарии
- Связка технического плана с PQC/Zero-Trust/mesh-трендами

**Файловые зоны**:
```
docs/go-to-market/   # GTM материалы
docs/grants/         # Заявки на гранты
business/            # Бизнес-планы
```

---

## Конвейер работы (Pipeline)

```
┌─────────────────────────────────────────────────────────────────┐
│                     SWARM DEVELOPMENT PIPELINE                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐  │
│  │  ШАГ 1   │───▶│  ШАГ 2   │───▶│  ШАГ 3   │───▶│  ШАГ 4   │  │
│  │  DESIGN  │    │  CODE    │    │VARIANTS  │    │  REVIEW  │  │
│  │ (Gemini) │    │ (Codex)  │    │ (GLM-5)  │    │ (Claude) │  │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘  │
│       │              │               │               │          │
│       ▼              ▼               ▼               ▼          │
│   plans/         src/          experiments/     Code Review     │
│   docs/adr       tests/        tests/load      + Refactor       │
│                                                                  │
│                          │                                       │
│                          ▼                                       │
│                   ┌──────────┐                                   │
│                   │  ШАГ 5   │                                   │
│                   │INTEGRATE │                                   │
│                   │(Human)   │                                   │
│                   └──────────┘                                   │
│                          │                                       │
│                          ▼                                       │
│                   STATUS.md, roadmap, merge                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Шаг 1: Дизайн (Gemini)

**Вход**: Issue/тикет с описанием фичи

**Действия**:
1. Сформулировать цель
2. Описать интерфейсы (модели, эндпоинты)
3. Прописать acceptance-criteria
4. Накидать структуру файлов и TODO

**Выход**: Документ в `plans/` или описание MR

**Пример**:
```markdown
# plans/swarm-phase2.md

## Цель
Реализовать Swarm Intelligence Phase 2 с распределённым decision making.

## Интерфейсы
- SwarmDecision(BaseModel): decision_id, participants, consensus_level
- POST /api/v1/swarm/propose: предложить решение
- GET /api/v1/swarm/status/{id}: статус голосования

## TODO для Codex
- [ ] Создать src/swarm/decision.py
- [ ] Добавить эндпоинты в src/api/swarm.py
- [ ] Написать тесты tests/test_swarm_decision.py
```

---

### Шаг 2: Черновой код (Codex)

**Вход**: Дизайн от Gemini

**Действия**:
1. Реализовать указанные модули
2. Добавить модели Pydantic
3. Написать юнит-тесты

**Выход**: Код в `src/`, тесты в `tests/`

**Проверка**: `pytest tests/` должен проходить

---

### Шаг 3: Усиление/Альтернативы (GLM-5)

**Вход**: Готовая реализация от Codex

**Действия**:
1. Предложить дополнительные edge-кейсы
2. Предложить альтернативный алгоритм/оптимизацию
3. Сгенерировать нагрузочные сценарии

**Выход**: 
- Дополнительные тесты в `tests/`
- Эксперименты в `experiments/`
- Нагрузочные тесты в `tests/load/`

---

### Шаг 4: Финальный ревью (Claude)

**Вход**: Весь diff от Codex + GLM-5

**Действия**:
1. Подробный code review
2. Найти баги, улучшить читаемость
3. Предложить микрорефакторинг

**Выход**: Патчи с исправлениями

---

### Шаг 5: Интеграция (Human)

**Вход**: Проверенный код

**Действия**:
1. Merge в основную ветку
2. Обновить `STATUS.md`, roadmap
3. При необходимости — OpenAPI/доки

**Выход**: Обновлённый репозиторий

---

## Веточный Workflow

```
main
  │
  ├── feature/maas-billing ────────▶ Codex работает здесь
  │         │
  │         └── experiment/billing-opt ──▶ GLM-5 эксперименты
  │
  ├── feature/swarm-phase2 ─────────▶ Codex работает здесь
  │         │
  │         └── experiment/swarm-alt ──▶ GLM-5 альтернативы
  │
  └── docs/architecture-update ─────▶ Gemini работает здесь
```

---

## Правила предотвращения конфликтов

### 1. Разделение файлов по агентам

| Агент | Разрешённые директории | Запрещённые |
|-------|------------------------|-------------|
| Gemini | `plans/`, `docs/adr/`, `docs/*.md` | `src/`, `tests/`, конфиги |
| Codex | `src/`, `tests/`, `alembic/` | `plans/`, roadmap, STATUS |
| Claude | Точечные правки в уже затронутых файлах | Новые файлы с нуля |
| GLM-5 | `experiments/`, `tests/load/`, `benchmarks/` | `src/` без review |

### 2. Ясные промпты с запретами

**Обязательно указывать**:
```
НЕ изменяй ничего вне указанных файлов.
НЕ трогай конфигурацию CI/CD и roadmap.
```

### 3. Единый источник правды

**Под контролем человека**:
- `docs/STATUS.md`
- `docs/ROADMAP.md`
- `.gitlab-ci.yml`
- `deploy/helm/maas/values.yaml`

---

## Пример: Разработка фичи Swarm Intelligence Phase 2

### Шаг 1: Gemini — Дизайн

**Промпт**:
```
Спроектируй Swarm Intelligence Phase 2 для MaaS x0tta6bl4.

Требования:
- Распределённое decision making
- Консенсус через голосование узлов
- Интеграция с MAPE-K loop

Выдай:
1. Архитектуру модулей
2. Pydantic схемы
3. TODO для реализации

НЕ пиши код, только дизайн.
```

### Шаг 2: Codex — Реализация

**Промпт**:
```
Реализуй Swarm Intelligence Phase 2 по ТЗ:
[вставить ТЗ от Gemini]

Файлы для создания:
- src/swarm/decision.py
- src/swarm/consensus.py
- tests/test_swarm_decision.py

Требования:
- Только указанное поведение
- Не менять другие модули
- 100% coverage для новых функций
```

### Шаг 3: GLM-5 — Альтернативы

**Промпт**:
```
Для реализации Swarm Decision предложи:
1. 3 альтернативных алгоритма консенсуса (Raft, PBFT, Swarm)
2. Edge-кейсы: split-brain, network partition, Byzantine nodes
3. Нагрузочный сценарий: 1000 узлов, 100 decisions/sec
4. Идеи оптимизации: кеширование, batching

Создай файлы в experiments/swarm/
```

### Шаг 4: Claude — Ревью

**Промпт**:
```
Сделай code review для:
- src/swarm/decision.py
- src/swarm/consensus.py

Проверь:
- Race conditions в голосовании
- Обработку network partitions
- Соответствие Zero-Trust принципам
- Полноту тестов

Предложи микрорефакторинг без смены поведения.
```

### Шаг 5: Интеграция

**Действия человека**:
1. `git merge feature/swarm-phase2`
2. Обновить `STATUS.md`
3. Запустить full test suite
4. Deploy на staging

---

## Мониторинг конвейера

### Метрики эффективности

| Метрика | Цель | Измерение |
|---------|------|-----------|
| Time to First Code | < 2 часа | Issue → первый коммит Codex |
| Review Turnaround | < 4 часа | Коммит → ревью Claude |
| Bug Escape Rate | < 5% | Баги после merge |
| Test Coverage | > 90% | pytest --cov |

### Алерты

- ⚠️ Codex изменил файл вне зоны → Эскалация
- ⚠️ Gemini написал код → Эскалация
- ⚠️ GLM-5 в main ветке → Эскалация

---

## Обновление документа

Этот документ обновляется:
- При изменении ролей агентов
- При добавлении новых инструментов
- При изменении workflow

Последнее обновление: 2026-02-21
