<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>x0tta6bl4 - Interactive Mesh Demo</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f1419;
            color: #e6e6e6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .controls {
            background: #1a1f2e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #4a5568;
            cursor: not-allowed;
            transform: none;
        }
        
        button.destroy {
            background: #f56565;
        }
        
        button.destroy:hover {
            background: #e53e3e;
        }
        
        button.reset {
            background: #48bb78;
        }
        
        button.reset:hover {
            background: #38a169;
        }
        
        .mesh-container {
            background: #1a1f2e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        #mesh-canvas {
            width: 100%;
            height: 600px;
            background: #0f1419;
            border-radius: 8px;
        }
        
        .metrics {
            background: #1a1f2e;
            padding: 20px;
            border-radius: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .metric-card {
            background: #252a3a;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 0.9em;
            opacity: 0.7;
        }
        
        .timeline {
            background: #1a1f2e;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .timeline h3 {
            margin-bottom: 15px;
            color: #667eea;
        }
        
        .timeline-event {
            padding: 10px;
            margin-bottom: 10px;
            background: #252a3a;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            font-size: 0.9em;
        }
        
        .timeline-event.failed {
            border-left-color: #f56565;
        }
        
        .timeline-event.recovered {
            border-left-color: #48bb78;
        }
        
        .status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 6px;
            text-align: center;
        }
        
        .status.success {
            background: #22543d;
            color: #9ae6b4;
        }
        
        .status.error {
            background: #742a2a;
            color: #fc8181;
        }
        
        .status.info {
            background: #2c5282;
            color: #90cdf4;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üï∏Ô∏è x0tta6bl4 Interactive Mesh Demo</h1>
            <p>Click "DESTROY NODE" to break a node and watch it heal automatically!</p>
        </div>
        
        <div id="status" class="status info" style="display: none;"></div>
        
        <div class="controls">
            <button id="create-btn" onclick="createDemo()">Create Network</button>
            <button id="destroy-btn" class="destroy" onclick="destroyRandomNode()" disabled>DESTROY NODE</button>
            <button id="reset-btn" class="reset" onclick="resetDemo()" disabled>Reset</button>
            <button onclick="shareDemo()">Share</button>
        </div>
        
        <div class="mesh-container">
            <svg id="mesh-canvas"></svg>
        </div>
        
        <div class="metrics">
            <div class="metric-card">
                <div class="metric-value" id="mttr-value">-</div>
                <div class="metric-label">MTTR (seconds)</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="recovery-value">-</div>
                <div class="metric-label">Recovery Time</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="healthy-value">-</div>
                <div class="metric-label">Healthy Nodes</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="total-value">-</div>
                <div class="metric-label">Total Nodes</div>
            </div>
        </div>
        
        <div class="timeline">
            <h3>üìà Timeline</h3>
            <div id="timeline-events">No events yet. Create a network to start!</div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8082';  // –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL
        let currentSessionId = null;
        let simulation = null;
        let nodes = [];
        let links = [];
        
        async function createDemo() {
            try {
                showStatus('Creating network...', 'info');
                
                const response = await fetch(`${API_BASE}/api/demo/interactive/create?num_nodes=5`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                currentSessionId = data.session_id;
                
                showStatus('Network created! Click "DESTROY NODE" to test self-healing.', 'success');
                
                document.getElementById('create-btn').disabled = true;
                document.getElementById('destroy-btn').disabled = false;
                document.getElementById('reset-btn').disabled = false;
                
                await updateVisualization();
            } catch (error) {
                showStatus('Error creating network: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        async function destroyRandomNode() {
            if (!currentSessionId) return;
            
            try {
                // –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —É–∑–ª–∞
                const statusResponse = await fetch(`${API_BASE}/api/demo/interactive/status/${currentSessionId}`);
                const status = await statusResponse.json();
                
                // –í—ã–±—Ä–∞—Ç—å —Å–ª—É—á–∞–π–Ω—ã–π –∑–¥–æ—Ä–æ–≤—ã–π —É–∑–µ–ª
                const healthyNodes = status.nodes.filter(n => n.status === 'healthy');
                if (healthyNodes.length === 0) {
                    showStatus('All nodes are already failed! Click Reset to start over.', 'error');
                    return;
                }
                
                const randomNode = healthyNodes[Math.floor(Math.random() * healthyNodes.length)];
                
                showStatus(`Destroying node ${randomNode.id}...`, 'info');
                document.getElementById('destroy-btn').disabled = true;
                
                const response = await fetch(`${API_BASE}/api/demo/interactive/destroy/${currentSessionId}/${randomNode.id}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                showStatus(`Node ${randomNode.id} recovered in ${result.mttr.toFixed(2)}s!`, 'success');
                
                document.getElementById('destroy-btn').disabled = false;
                
                await updateVisualization();
                await updateMetrics();
                await updateTimeline();
            } catch (error) {
                showStatus('Error destroying node: ' + error.message, 'error');
                document.getElementById('destroy-btn').disabled = false;
                console.error(error);
            }
        }
        
        async function resetDemo() {
            if (!currentSessionId) return;
            
            try {
                await fetch(`${API_BASE}/api/demo/interactive/reset/${currentSessionId}`, {
                    method: 'POST'
                });
                
                showStatus('Network reset! All nodes are healthy.', 'success');
                await updateVisualization();
                await updateMetrics();
                await updateTimeline();
            } catch (error) {
                showStatus('Error resetting: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        async function updateVisualization() {
            if (!currentSessionId) return;
            
            const response = await fetch(`${API_BASE}/api/demo/interactive/status/${currentSessionId}`);
            const data = await response.json();
            
            nodes = data.nodes;
            links = data.links;
            
            const svg = d3.select('#mesh-canvas');
            svg.selectAll('*').remove();
            
            const width = svg.node().getBoundingClientRect().width;
            const height = svg.node().getBoundingClientRect().height;
            
            // –°–æ–∑–¥–∞—Ç—å force simulation
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(150))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2));
            
            // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Å–≤—è–∑–∏
            const link = svg.append('g')
                .selectAll('line')
                .data(links)
                .enter()
                .append('line')
                .attr('stroke', d => {
                    if (d.status === 'healthy') return '#48bb78';
                    if (d.status === 'failed') return '#f56565';
                    return '#a0aec0';
                })
                .attr('stroke-width', 2)
                .attr('opacity', 0.6);
            
            // –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —É–∑–ª—ã
            const node = svg.append('g')
                .selectAll('circle')
                .data(nodes)
                .enter()
                .append('circle')
                .attr('r', 25)
                .attr('fill', d => {
                    if (d.status === 'healthy') return '#48bb78';
                    if (d.status === 'failed') return '#f56565';
                    if (d.status === 'recovering') return '#ed8936';
                    return '#a0aec0';
                })
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .call(drag(simulation));
            
            // –î–æ–±–∞–≤–∏—Ç—å labels
            const label = svg.append('g')
                .selectAll('text')
                .data(nodes)
                .enter()
                .append('text')
                .text(d => d.id)
                .attr('font-size', '12px')
                .attr('fill', '#fff')
                .attr('text-anchor', 'middle')
                .attr('dy', 35);
            
            // –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏ —Å–∏–º—É–ª—è—Ü–∏–∏
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                label
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
        }
        
        async function updateMetrics() {
            if (!currentSessionId) return;
            
            const response = await fetch(`${API_BASE}/api/demo/interactive/metrics/${currentSessionId}`);
            const metrics = await response.json();
            
            document.getElementById('mttr-value').textContent = metrics.avg_mttr.toFixed(2) || '-';
            document.getElementById('recovery-value').textContent = metrics.avg_mttr.toFixed(2) + 's' || '-';
            document.getElementById('healthy-value').textContent = metrics.healthy_nodes;
            document.getElementById('total-value').textContent = metrics.total_nodes;
        }
        
        async function updateTimeline() {
            if (!currentSessionId) return;
            
            const response = await fetch(`${API_BASE}/api/demo/interactive/status/${currentSessionId}`);
            const data = await response.json();
            
            const timelineDiv = document.getElementById('timeline-events');
            if (data.events.length === 0) {
                timelineDiv.innerHTML = 'No events yet.';
                return;
            }
            
            timelineDiv.innerHTML = data.events.slice().reverse().map(event => {
                const date = new Date(event.timestamp * 1000);
                const timeStr = date.toLocaleTimeString();
                
                let className = '';
                let emoji = 'üìä';
                if (event.type === 'node_failed') {
                    className = 'failed';
                    emoji = 'üî¥';
                } else if (event.type === 'node_recovered') {
                    className = 'recovered';
                    emoji = 'üü¢';
                }
                
                return `
                    <div class="timeline-event ${className}">
                        ${emoji} <strong>${timeStr}</strong> - ${event.type.replace(/_/g, ' ')} (${event.node_id})
                        ${event.data.mttr ? ` - MTTR: ${event.data.mttr.toFixed(2)}s` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
        
        function shareDemo() {
            if (!currentSessionId) {
                showStatus('Create a network first!', 'error');
                return;
            }
            
            const url = `${window.location.origin}${window.location.pathname}?session=${currentSessionId}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'x0tta6bl4 Interactive Mesh Demo',
                    text: 'Check out this self-healing mesh network!',
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url);
                showStatus('Link copied to clipboard!', 'success');
            }
        }
        
        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }
            
            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }
            
            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
            
            return d3.drag()
                .on('start', dragstarted)
                .on('drag', dragged)
                .on('end', dragended);
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–µ—Å—Å–∏—é –∏–∑ URL
        window.addEventListener('load', () => {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('session');
            if (sessionId) {
                currentSessionId = sessionId;
                document.getElementById('create-btn').disabled = true;
                document.getElementById('destroy-btn').disabled = false;
                document.getElementById('reset-btn').disabled = false;
                updateVisualization();
                updateMetrics();
        });
    </script>
</body>
</html>

