<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>x0tta6bl4 - Causal Analysis Dashboard</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f1419;
            color: #e6e6e6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: #1a1f2e;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .panel.full-width {
            grid-column: 1 / -1;
        }
        
        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .timeline {
            position: relative;
            padding: 20px 0;
        }
        
        .timeline-event {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #252a3a;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .timeline-event.root-cause {
            border-left-color: #f56565;
            background: #2a1f1f;
        }
        
        .timeline-event.anomaly {
            border-left-color: #ed8936;
        }
        
        .timeline-event.correlation {
            border-left-color: #48bb78;
        }
        
        .timeline-time {
            font-size: 0.9em;
            opacity: 0.7;
            margin-right: 15px;
            min-width: 120px;
        }
        
        .timeline-content {
            flex: 1;
        }
        
        .timeline-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .timeline-desc {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .root-cause-card {
            background: #2a1f1f;
            border: 2px solid #f56565;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        
        .root-cause-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .root-cause-type {
            font-size: 1.3em;
            font-weight: 600;
            color: #f56565;
        }
        
        .confidence-badge {
            background: #f56565;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .remediation-list {
            list-style: none;
            margin-top: 15px;
        }
        
        .remediation-list li {
            padding: 10px;
            background: #1a1f2e;
            margin-bottom: 8px;
            border-radius: 5px;
            border-left: 3px solid #48bb78;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .metric-card {
            background: #252a3a;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-label {
            font-size: 0.9em;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: 600;
            color: #667eea;
        }
        
        .dependency-graph {
            width: 100%;
            height: 400px;
            background: #0f1419;
            border-radius: 8px;
        }
        
        .node {
            cursor: pointer;
        }
        
        .node.root-cause {
            fill: #f56565;
        }
        
        .node.failed {
            fill: #ed8936;
        }
        
        .node.degraded {
            fill: #48bb78;
        }
        
        .link {
            stroke: #667eea;
            stroke-opacity: 0.6;
            stroke-width: 2;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5568d3;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }
        
        .spinner {
            border: 4px solid #252a3a;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .timeline-event {
            opacity: 0;
            transform: translateX(-20px);
            animation: fadeInSlide 0.5s ease-out forwards;
        }
        
        .timeline-event:nth-child(1) { animation-delay: 0.1s; }
        .timeline-event:nth-child(2) { animation-delay: 0.3s; }
        .timeline-event:nth-child(3) { animation-delay: 0.5s; }
        .timeline-event:nth-child(4) { animation-delay: 0.7s; }
        
        @keyframes fadeInSlide {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .root-cause-card {
            opacity: 0;
            transform: scale(0.9);
            animation: scaleIn 0.5s ease-out forwards;
        }
        
        .root-cause-card:nth-child(1) { animation-delay: 0.2s; }
        .root-cause-card:nth-child(2) { animation-delay: 0.4s; }
        
        @keyframes scaleIn {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .metric-card {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.5s ease-out forwards;
        }
        
        .metric-card:nth-child(1) { animation-delay: 0.1s; }
        .metric-card:nth-child(2) { animation-delay: 0.2s; }
        .metric-card:nth-child(3) { animation-delay: 0.3s; }
        .metric-card:nth-child(4) { animation-delay: 0.4s; }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .timeline-event:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .root-cause-card:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(245, 101, 101, 0.3);
            transition: all 0.3s ease;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .severity-critical { border-left-color: #f56565 !important; }
        .severity-high { border-left-color: #ed8936 !important; }
        .severity-medium { border-left-color: #48bb78 !important; }
        .severity-low { border-left-color: #667eea !important; }
        
        .copy-link-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            margin-left: 10px;
            transition: background 0.3s;
        }
        
        .copy-link-btn:hover {
            background: #38a169;
        }
        
        .copy-link-btn.copied {
            background: #667eea;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .timeline-event {
                flex-direction: column;
            }
            
            .timeline-time {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Causal Analysis Dashboard</h1>
            <p>x0tta6bl4 Self-Healing Mesh - AI-Powered Root Cause Analysis</p>
        </div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <button class="btn" onclick="loadDemo()" id="loadDemoBtn">üöÄ Load Demo Incident</button>
            <button class="btn" onclick="loadIncident()" style="margin-left: 10px;">üìä Load Incident</button>
            <button class="copy-link-btn" onclick="copyDemoLink()" id="copyLinkBtn">üìã Copy Demo Link</button>
        </div>
        
        <div id="dashboard" class="loading">
            <p>Click "Load Demo Incident" to see causal analysis visualization</p>
        </div>
    </div>
    
    <script>
        const API_BASE = window.location.origin + '/api/causal-analysis';
        
        async function loadDemo() {
            const dashboard = document.getElementById('dashboard');
            const btn = document.getElementById('loadDemoBtn');
            
            // Show loading state
            dashboard.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Generating demo incident...</p>
                    <p style="font-size: 0.9em; opacity: 0.7; margin-top: 10px;">This may take a few seconds</p>
                </div>
            `;
            btn.disabled = true;
            btn.textContent = '‚è≥ Loading...';
            
            try {
                const response = await fetch(`${API_BASE}/demo`, { method: 'POST' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                // Small delay for smooth transition
                await new Promise(resolve => setTimeout(resolve, 300));
                
                renderDashboard(data.dashboard_data);
            } catch (error) {
                dashboard.innerHTML = `
                    <div class="loading">
                        <p style="color: #f56565;">‚ùå Error: ${error.message}</p>
                        <p style="font-size: 0.9em; opacity: 0.7; margin-top: 10px;">
                            Make sure the server is running: <code>python -m src.core.app</code>
                        </p>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.textContent = 'üöÄ Load Demo Incident';
            }
        }
        
        async function loadIncident(incidentId = 'demo-main-001') {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '<div class="loading">Loading incident...</div>';
            
            try {
                const response = await fetch(`${API_BASE}/incidents/${incidentId}`);
                const data = await response.json();
                renderDashboard(data);
            } catch (error) {
                dashboard.innerHTML = `<div class="loading">Error: ${error.message}</div>`;
            }
        }
        
        function renderDashboard(data) {
            const dashboard = document.getElementById('dashboard');
            
            let html = `
                <div class="dashboard-grid">
                    <div class="panel full-width">
                        <h2>üìä Timeline</h2>
                        <div class="timeline">
                            ${data.timeline.map((event, idx) => `
                                <div class="timeline-event ${event.event_type} severity-${event.severity}" style="animation-delay: ${idx * 0.2}s">
                                    <div class="timeline-time">${new Date(event.timestamp).toLocaleTimeString()}</div>
                                    <div class="timeline-content">
                                        <div class="timeline-title">${event.title}</div>
                                        <div class="timeline-desc">${event.description}</div>
                                        ${event.confidence ? `<div style="margin-top: 5px; font-size: 0.85em; opacity: 0.8;">Confidence: ${(event.confidence * 100).toFixed(0)}%</div>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="panel">
                        <h2>üéØ Root Causes</h2>
                        ${data.root_causes.map(rc => `
                            <div class="root-cause-card">
                                <div class="root-cause-header">
                                    <div class="root-cause-type">${rc.root_cause_type}</div>
                                    <div class="confidence-badge">${(rc.confidence * 100).toFixed(0)}%</div>
                                </div>
                                <p>${rc.explanation}</p>
                                <ul class="remediation-list">
                                    ${rc.remediation_suggestions.map(s => `<li>${s}</li>`).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="panel">
                        <h2>üìà Metrics</h2>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <div class="metric-label">Total Events</div>
                                <div class="metric-value">${data.analysis_metadata.total_events}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Root Causes</div>
                                <div class="metric-value">${data.analysis_metadata.root_causes_count}</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Confidence</div>
                                <div class="metric-value">${(data.analysis_metadata.overall_confidence * 100).toFixed(0)}%</div>
                            </div>
                            <div class="metric-card">
                                <div class="metric-label">Analysis Time</div>
                                <div class="metric-value">${data.analysis_metadata.analysis_time_ms.toFixed(0)}ms</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="panel full-width">
                        <h2>üîó Dependency Graph</h2>
                        <div id="dependency-graph" class="dependency-graph"></div>
                    </div>
                </div>
            `;
            
            dashboard.innerHTML = html;
            
            // Render dependency graph with delay for animation
            setTimeout(() => {
                renderDependencyGraph(data.dependency_graph);
                scrollToTimeline();
            }, 100);
        }
        
        function renderDependencyGraph(graphData) {
            const svg = d3.select("#dependency-graph")
                .append("svg")
                .attr("width", "100%")
                .attr("height", "400");
            
            const width = svg.node().getBoundingClientRect().width;
            const height = 400;
            
            const simulation = d3.forceSimulation(graphData.nodes)
                .force("link", d3.forceLink(graphData.edges).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2));
            
            const link = svg.append("g")
                .selectAll("line")
                .data(graphData.edges)
                .enter().append("line")
                .attr("class", "link")
                .attr("opacity", 0)
                .attr("stroke-width", 0)
                .transition()
                .duration(800)
                .delay((d, i) => i * 50)
                .attr("opacity", 0.6)
                .attr("stroke-width", 2);
            
            const node = svg.append("g")
                .selectAll("circle")
                .data(graphData.nodes)
                .enter().append("circle")
                .attr("class", d => `node ${d.status}`)
                .attr("r", 0)
                .attr("opacity", 0)
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended))
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("r", 15).attr("opacity", 1);
                })
                .on("mouseout", function(event, d) {
                    d3.select(this).attr("r", 10).attr("opacity", 1);
                })
                .transition()
                .duration(1000)
                .delay((d, i) => i * 100)
                .attr("r", 10)
                .attr("opacity", 1);
            
            const label = svg.append("g")
                .selectAll("text")
                .data(graphData.nodes)
                .enter().append("text")
                .text(d => d.label)
                .attr("fill", "#e6e6e6")
                .attr("font-size", "12px");
            
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);
                
                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);
                
                label
                    .attr("x", d => d.x + 15)
                    .attr("y", d => d.y + 5);
            });
            
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
        }
        
        function copyDemoLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                const btn = document.getElementById('copyLinkBtn');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                alert('Failed to copy link. Please copy manually: ' + url);
            });
        }
        
        // Add smooth scroll to timeline on load
        function scrollToTimeline() {
            const timeline = document.querySelector('.timeline');
            if (timeline) {
                setTimeout(() => {
                    timeline.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 500);
            }
        }
        
        // Auto-load demo on page load (optional - uncomment if desired)
        // window.addEventListener('load', () => {
        //     loadDemo();
        // });
    </script>
</body>
</html>

