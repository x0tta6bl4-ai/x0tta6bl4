server {
  # Binding address of SPIRE Server
  bind_address = "0.0.0.0"
  bind_port = 8081
  
  # Trust domain of the x0tta6bl4 mesh
  trust_domain = "x0tta6bl4.mesh"
  
  # Log level (DEBUG for development, INFO for production)
  log_level = "INFO"
  
  # Data directory
  data_dir = "/var/lib/spire/server"
  
  # Registration entries file (Unix socket)
  registration_uds_path = "/var/lib/spire/sockets/registration.sock"
  
  # SVID TTL (1 hour for security, adjust as needed)
  default_svid_ttl = "3600s"
  
  # SVID common name (for compatibility)
  ca_subject = {
    country = ["US"]
    organization = ["x0tta6bl4"]
    common_name = "x0tta6bl4 SPIFFE Authority"
  }
}

plugins {
  # SQLite backend (development/small deployments)
  # Switch to PostgreSQL for production:
  # database_type = "postgres"
  # connection_string = "host=postgres port=5432 user=spire password=... dbname=spire"
  DataStore "sql" {
    plugin_data {
      database_type = "sqlite3"
      connection_string = "/var/lib/spire/server/datastore.db"
    }
  }

  # In-memory KeyManager for development
  # For production: use Disk with encrypted keys
  KeyManager "memory" {
    plugin_data {}
  }

  # Node Attestors - for different deployment environments
  NodeAttestor "join_token" {
    plugin_data {}
  }

  NodeAttestor "aws_iid" {
    plugin_data {
      access_key = ""  # Use IAM role in production
      secret_key = ""  # Use IAM role in production
    }
  }

  NodeAttestor "k8s_sat" {
    plugin_data {
      clusters = {
        "local" = {
          service_account_whitelist = [
            "spire:spire-agent",
            "default:spire-agent",
            "kube-system:*"
          ]
          use_token_review_api = true
        }
      }
    }
  }

  # Workload Attestors
  WorkloadAttestor "unix" {
    plugin_data {
      discover_workload_path = true
    }
  }

  WorkloadAttestor "docker" {
    plugin_data {
      docker_socket_path = "/var/run/docker.sock"
      use_cgroups = true
    }
  }

  WorkloadAttestor "k8s" {
    plugin_data {
      node_name = "minikube"
      api_server_url = "https://kubernetes.default.svc:443"
      service_account_token_path = "/var/run/secrets/kubernetes.io/serviceaccount/token"
      cluster_name = "local"
    }
  }

  # Self-Signed CA for development
  # For production: use UpstreamCA "disk" with proper PKI
  UpstreamCA "memory" {
    plugin_data {}
  }
}

# Agent configuration
agent {
  # Agent joins with a short-lived token
  # Tokens are valid for 10 minutes by default
  # Change via: spire-server token generate
}

# Telemetry for monitoring
telemetry {
  Prometheus {
    bind_address = "0.0.0.0"
    bind_port = 8089
  }
}

