agent {
  # Data directory for agent state
  data_dir = "/var/lib/spire/agent"

  # Log level (DEBUG for development, INFO for production)
  log_level = "INFO"

  # SPIRE Server address to connect to
  server_address = "spire-server"
  server_port = 8081

  # Unix socket for Workload API
  socket_path = "/run/spire/sockets/agent.sock"
  
  # Socket permissions (0755 = rwxr-xr-x)
  socket_mode = "0755"

  # Trust domain (must match server)
  trust_domain = "x0tta6bl4.mesh"

  # Node attestation strategy
  # join_token: For development (requires token from spire-server token generate)
  # aws_iid: For AWS EC2 instances
  # k8s_sat: For Kubernetes pods
  default_node_attestor = "join_token"

  # Workload attestation
  # unix: For Unix processes (recommended for containerized workloads)
  # docker: For Docker containers
  # k8s: For Kubernetes pods
  default_workload_attestor = "unix"

  # SVID rotation check interval
  svid_check_interval = "10s"

  # Sync interval with SPIRE Server
  sync_interval = "30s"
}

plugins {
  # Key Manager for SVID keys
  KeyManager "disk" {
    plugin_data {
      directory = "/var/lib/spire/agent/keys"
    }
  }

  # Node Attestors
  NodeAttestor "join_token" {
    plugin_data {}
  }

  NodeAttestor "aws_iid" {
    plugin_data {
      # For production AWS deployments
      # access_key = "..."  (use IAM role instead)
      # secret_key = "..."  (use IAM role instead)
    }
  }

  NodeAttestor "k8s_sat" {
    plugin_data {
      cluster = "local"
      kube_config_file = ""  # Use in-cluster config if empty
    }
  }

  # Workload Attestors
  WorkloadAttestor "unix" {
    plugin_data {
      # Discover workload binary path
      discover_workload_path = true
    }
  }

  WorkloadAttestor "docker" {
    plugin_data {
      # Docker daemon socket
      docker_socket_path = "/var/run/docker.sock"
      # Use cgroups for process identification
      use_cgroups = true
    }
  }

  WorkloadAttestor "k8s" {
    plugin_data {
      # Node name for Kubernetes
      node_name = "minikube"
      # Kubernetes API server URL
      api_server_url = "https://kubernetes.default.svc:443"
      # Service account token (in-cluster)
      service_account_token_path = "/var/run/secrets/kubernetes.io/serviceaccount/token"
      # Cluster name for identification
      cluster_name = "local"
    }
  }

  # Workload API endpoint
  WorkloadAPI "unix" {
    plugin_data {
      socket_path = "/run/spire/sockets/agent.sock"
      # Allow spiffe SDK connections
      disable_auth = false
    }
  }
}

# Telemetry and monitoring
telemetry {
  # Prometheus metrics on port 8088
  Prometheus {
    bind_address = "0.0.0.0"
    bind_port = 8088
  }
}
