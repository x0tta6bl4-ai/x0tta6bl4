# Ingress конфигурация для региона us-east-1

---
# Ingress для основного приложения
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: x0tta6bl4-ingress
  namespace: x0tta6bl4-us-east-1
  labels:
    app.kubernetes.io/name: x0tta6bl4
    app.kubernetes.io/instance: us-east-1
    app.kubernetes.io/component: ingress
  annotations:
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP
    alb.ingress.kubernetes.io/healthcheck-port: traffic-port
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: "30"
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: "5"
    alb.ingress.kubernetes.io/healthy-threshold-count: "2"
    alb.ingress.kubernetes.io/unhealthy-threshold-count: "2"
    alb.ingress.kubernetes.io/success-codes: "200"
    # SSL настройки
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    alb.ingress.kubernetes.io/ssl-redirect: "true"
    alb.ingress.kubernetes.io/ssl-policy: "ELBSecurityPolicy-TLS-1-2-2017-01"
    # WAF интеграция
    alb.ingress.kubernetes.io/waf-acl-id: "arn:aws:wafv2:us-east-1:123456789012:regional/webacl/x0tta6bl4-webacl/12345678-1234-1234-1234-123456789012"
    # Логирование
    alb.ingress.kubernetes.io/load-balancer-attributes: "access_logs.s3.enabled=true,access_logs.s3.bucket=x0tta6bl4-alb-logs-us-east-1,access_logs.s3.prefix=alb-logs"
    # Защита от DDoS
    alb.ingress.kubernetes.io/shield-advanced-protection: "true"
spec:
  ingressClassName: alb
  tls:
  - hosts:
    - "us-east-1.x0tta6bl4.com"
    secretName: x0tta6bl4-tls
  rules:
  - host: "us-east-1.x0tta6bl4.com"
    http:
      paths:
      - path: /api/v1
        pathType: Prefix
        backend:
          service:
            name: x0tta6bl4-service
            port:
              number: 80
      - path: /health
        pathType: Exact
        backend:
          service:
            name: x0tta6bl4-service
            port:
              number: 80
      - path: /ready
        pathType: Exact
        backend:
          service:
            name: x0tta6bl4-service
            port:
              number: 80
      - path: /metrics
        pathType: Exact
        backend:
          service:
            name: x0tta6bl4-service
            port:
              number: 9090

---
# IngressClass для ALB
apiVersion: networking.k8s.io/v1
kind: IngressClass
metadata:
  name: alb
  labels:
    app.kubernetes.io/name: alb
    app.kubernetes.io/instance: us-east-1
  annotations:
    ingressclass.kubernetes.io/is-default-class: "true"
spec:
  controller: ingress.k8s.aws/alb

---
# Certificate для TLS шифрования
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: x0tta6bl4-tls
  namespace: x0tta6bl4-us-east-1
  labels:
    app.kubernetes.io/name: x0tta6bl4
    app.kubernetes.io/instance: us-east-1
    app.kubernetes.io/component: certificate
spec:
  secretName: x0tta6bl4-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
  - "us-east-1.x0tta6bl4.com"
  - "*.us-east-1.x0tta6bl4.com"

---
# ClusterIssuer для Let's Encrypt
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
  labels:
    app.kubernetes.io/name: letsencrypt-prod
    app.kubernetes.io/instance: us-east-1
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@x0tta6bl4.com
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: alb

---
# WAF WebACL для защиты от веб-атак
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: x0tta6bl4-vs
  namespace: x0tta6bl4-us-east-1
  labels:
    app.kubernetes.io/name: x0tta6bl4
    app.kubernetes.io/instance: us-east-1
    app.kubernetes.io/component: virtualservice
spec:
  hosts:
  - "us-east-1.x0tta6bl4.com"
  gateways:
  - x0tta6bl4-gateway
  http:
  - match:
    - uri:
        prefix: /api/v1
    route:
    - destination:
        host: x0tta6bl4-service
        port:
          number: 80
    corsPolicy:
      allowOrigin:
      - "*"
      allowMethods:
      - GET
      - POST
      - PUT
      - DELETE
      - OPTIONS
      allowHeaders:
      - "*"
      maxAge: "1728000"
  - match:
    - uri:
        prefix: /health
    route:
    - destination:
        host: x0tta6bl4-service
        port:
          number: 80
  - match:
    - uri:
        prefix: /ready
    route:
    - destination:
        host: x0tta6bl4-service
        port:
          number: 80

---
# Gateway для Istio
apiVersion: networking.istio.io/v1beta1
kind: Gateway
metadata:
  name: x0tta6bl4-gateway
  namespace: x0tta6bl4-us-east-1
  labels:
    app.kubernetes.io/name: x0tta6bl4
    app.kubernetes.io/instance: us-east-1
    app.kubernetes.io/component: gateway
spec:
  selector:
    istio: ingressgateway
  servers:
  - port:
      number: 80
      name: http
      protocol: HTTP
    hosts:
    - "us-east-1.x0tta6bl4.com"
    tls:
      httpsRedirect: true
  - port:
      number: 443
      name: https
      protocol: HTTPS
    hosts:
    - "us-east-1.x0tta6bl4.com"
    tls:
      mode: SIMPLE
      credentialName: x0tta6bl4-tls

---
# AuthorizationPolicy для безопасности
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: x0tta6bl4-authz
  namespace: x0tta6bl4-us-east-1
  labels:
    app.kubernetes.io/name: x0tta6bl4
    app.kubernetes.io/instance: us-east-1
    app.kubernetes.io/component: authorization
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: x0tta6bl4
      app.kubernetes.io/instance: us-east-1
  rules:
  - key: request.headers[authorization]
    values: ["Bearer *"]
  - from:
    - source:
        namespaces: ["istio-system"]
    to:
    - operation:
        paths: ["/health", "/ready", "/metrics"]

---
# PeerAuthentication для mTLS
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: x0tta6bl4-mtls
  namespace: x0tta6bl4-us-east-1
  labels:
    app.kubernetes.io/name: x0tta6bl4
    app.kubernetes.io/instance: us-east-1
    app.kubernetes.io/component: peerauthentication
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: x0tta6bl4
      app.kubernetes.io/instance: us-east-1
  mtls:
    mode: PERMISSIVE

---
# RequestAuthentication для JWT валидации
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: x0tta6bl4-jwt
  namespace: x0tta6bl4-us-east-1
  labels:
    app.kubernetes.io/name: x0tta6bl4
    app.kubernetes.io/instance: us-east-1
    app.kubernetes.io/component: requestauthentication
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: x0tta6bl4
      app.kubernetes.io/instance: us-east-1
  jwtRules:
  - issuer: "x0tta6bl4.auth"
    jwksUri: "https://auth.x0tta6bl4.com/.well-known/jwks.json"
    forwardOriginalToken: true