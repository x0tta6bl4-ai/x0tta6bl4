services:
  spire-server:
    image: ghcr.io/spiffe/spire-server:1.9.0
    container_name: spire-server
    hostname: spire-server
    expose:
      - 8081
    volumes:
      - ./scripts/spire/server-config.conf:/etc/spire/server.conf:ro
      - spire-data:/spire/data
    command:
      - -config=/etc/spire/server.conf
    networks:
      - spire-net

  spire-agent:
    image: ghcr.io/spiffe/spire-agent:1.9.0
    container_name: spire-agent
    hostname: spire-agent
    pid: host
    depends_on:
      - spire-server
    volumes:
      - ./scripts/spire/agent-config.conf:/etc/spire/agent.conf:ro
      - /tmp/spire-agent/public:/spire-agent-socket-dir
      - spire-agent-data:/spire/data/agent
    command:
      - -config=/etc/spire/agent.conf
      - -joinToken=${SPIRE_JOIN_TOKEN:-}
    networks:
      - spire-net

  # Test service with SPIRE agent
  x0tta6bl4-test:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: x0tta6bl4-test
    depends_on:
      - spire-agent
    environment:
      SPIRE_AGENT_ADDRESS: unix:///spire-agent-socket-dir/api.sock
    volumes:
      - /tmp/spire-agent/public:/spire-agent-socket-dir:ro
      - ./src:/app/src:ro
      - ./tests:/app/tests:ro
    networks:
      - spire-net
    command:
      - python
      - -m
      - pytest
      - tests/
      - -v

volumes:
  spire-data:
  spire-agent-data:

networks:
  spire-net:
    driver: bridge
