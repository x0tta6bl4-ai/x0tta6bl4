---
# Example Deployment for proxy-api with Vault secret injection
# This demonstrates how to use the Vault Agent Injector to automatically
# inject secrets into the proxy-api application.

apiVersion: apps/v1
kind: Deployment
metadata:
  name: proxy-api
  namespace: default
  labels:
    app: proxy-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: proxy-api
  template:
    metadata:
      labels:
        app: proxy-api
      # Vault Agent Injector annotations
      annotations:
        # Enable Vault Agent injection
        vault.hashicorp.com/agent-inject: "true"
        
        # Vault role to use
        vault.hashicorp.com/role: "proxy-api"
        
        # Vault address
        vault.hashicorp.com/service: "https://vault.vault.svc.cluster.local:8200"
        
        # TLS verification (set to "false" only for dev/testing)
        vault.hashicorp.com/tls-skip-verify: "false"
        
        # Agent resource limits
        vault.hashicorp.com/agent-requests-cpu: "100m"
        vault.hashicorp.com/agent-requests-mem: "128Mi"
        vault.hashicorp.com/agent-limits-cpu: "250m"
        vault.hashicorp.com/agent-limits-mem: "256Mi"
        
        # Secret injection configurations
        # Database credentials
        vault.hashicorp.com/agent-inject-secret-database: "secret/data/proxy/database/main-db"
        vault.hashicorp.com/agent-inject-template-database: |
          {{ with secret "secret/data/proxy/database/main-db" -}}
          export DB_USERNAME="{{ .Data.data.username }}"
          export DB_PASSWORD="{{ .Data.data.password }}"
          export DB_HOST="{{ .Data.data.host }}"
          export DB_PORT="{{ .Data.data.port }}"
          export DB_NAME="{{ .Data.data.database }}"
          export DATABASE_URL="{{ .Data.data.connection_string }}"
          {{- end }}
        
        # API credentials for external services
        vault.hashicorp.com/agent-inject-secret-api-keys: "secret/data/proxy/api-keys/stripe"
        vault.hashicorp.com/agent-inject-template-api-keys: |
          {{ with secret "secret/data/proxy/api-keys/stripe" -}}
          export STRIPE_API_KEY="{{ .Data.data.api_key }}"
          export STRIPE_API_SECRET="{{ .Data.data.api_secret }}"
          {{- end }}
        
        # Proxy service credentials
        vault.hashicorp.com/agent-inject-secret-proxy-creds: "secret/data/proxy/credentials/proxy-api"
        vault.hashicorp.com/agent-inject-template-proxy-creds: |
          {{ with secret "secret/data/proxy/credentials/proxy-api" -}}
          export PROXY_API_KEY="{{ .Data.data.api_key }}"
          export PROXY_SECRET="{{ .Data.data.secret }}"
          {{- end }}
        
        # TLS certificates
        vault.hashicorp.com/agent-inject-secret-tls-cert: "secret/data/proxy/certificates/api-server"
        vault.hashicorp.com/agent-inject-template-tls-cert: |
          {{ with secret "secret/data/proxy/certificates/api-server" -}}
          {{ .Data.data.certificate }}
          {{- end }}
        vault.hashicorp.com/agent-inject-file-tls-cert: "/vault/secrets/tls.crt"
        
        vault.hashicorp.com/agent-inject-secret-tls-key: "secret/data/proxy/certificates/api-server"
        vault.hashicorp.com/agent-inject-template-tls-key: |
          {{ with secret "secret/data/proxy/certificates/api-server" -}}
          {{ .Data.data.private_key }}
          {{- end }}
        vault.hashicorp.com/agent-inject-file-tls-key: "/vault/secrets/tls.key"
        
        # Run agent as init container only (no sidecar)
        # Set to "false" to keep the agent running as a sidecar for secret rotation
        vault.hashicorp.com/agent-pre-populate-only: "false"
        
        # Configure secret rotation check interval
        vault.hashicorp.com/agent-inject-token: "false"
        
    spec:
      serviceAccountName: proxy-api
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      
      containers:
        - name: proxy-api
          image: proxy-api:latest
          imagePullPolicy: Always
          
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
            - name: metrics
              containerPort: 9090
              protocol: TCP
          
          env:
            # These will be populated by Vault Agent
            - name: DB_USERNAME
              value: ""
            - name: DB_PASSWORD
              value: ""
            - name: DATABASE_URL
              value: ""
            
            # Vault configuration for app-side client (if using hvac client)
            - name: VAULT_ADDR
              value: "https://vault.vault.svc.cluster.local:8200"
            - name: VAULT_K8S_ROLE
              value: "proxy-api"
            - name: VAULT_CACHE_TTL
              value: "3600"
          
          # Load secrets from files injected by Vault Agent
          volumeMounts:
            - name: vault-secrets
              mountPath: /vault/secrets
              readOnly: true
          
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
          
          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
          
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 1000
      
      # Volume for Vault-injected secrets
      volumes:
        - name: vault-secrets
          emptyDir:
            medium: Memory
      
      # Pod topology spread for HA
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: ScheduleAnyway
          labelSelector:
            matchLabels:
              app: proxy-api

---
# Service for proxy-api
apiVersion: v1
kind: Service
metadata:
  name: proxy-api
  namespace: default
  labels:
    app: proxy-api
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
    - port: 9090
      targetPort: metrics
      protocol: TCP
      name: metrics
  selector:
    app: proxy-api

---
# HorizontalPodAutoscaler for proxy-api
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: proxy-api
  namespace: default
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: proxy-api
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 15
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 10
          periodSeconds: 60