# Техническая спецификация: Оптимизация 3D сцены

## Контекст

**Язык**: TypeScript + React 18.2.0  
**Фреймворк 3D**: Three.js r160+  
**Текущее состояние**: Scene3D.tsx содержит базовую оптимизацию (InstancedMesh, materialCache), но есть потенциал для улучшения производительности.

---

## Проблемы (текущее состояние)

1. **Отсутствие LOD** — все панели рендерятся с одинаковым качеством независимо от расстояния до камеры
2. **Неэффективное управление материалами** — Canvas для текстур создается каждый раз при вызове `getMaterial()`
3. **Нет оптимизации теней** — shadowMap может быть дорогостоящей на мобильных
4. **Отсутствие frustum culling** — невидимые панели всё ещё обновляются
5. **InstancedMesh уже используется**, но нет автоматического пересоздания при изменении видимости слоев
6. **Отсутствие оптимизации памяти** — нет лимита на кэш материалов и текстур

---

## Подход реализации

### 1. **LOD система для панелей**
- Создать класс `OptimizedPanel` с THREE.LOD
- HIGH: полная качество для близких объектов (distance < 1500)
- MID: упрощённая геометрия (distance 1500-3000)
- LOW: простой bbox (distance > 3000)

### 2. **Оптимизированное управление материалами**
- Создать `TextureManager` для кэширования Canvas текстур
- Отделить текстуры от материалов для переиспользования
- Добавить LRU кэш с лимитом (max 32 текстуры, max 16 материалов)
- Переиспользовать Canvas текстуры для однотипных панелей

### 3. **Frustum Culling**
- Добавить проверку видимости панелей через `Frustum` перед рендерингом
- Отключить обновление transforms для невидимых панелей

### 4. **Оптимизация теней**
- Динамическое отключение shadowMap на мобильных (уже сделано)
- Использовать `PCFSoftShadowMap` вместо `PCFShadowMap` для быстроты
- Оптимизировать разрешение shadow map (512 вместо 1024 на мобильных)

### 5. **Улучшенная работа с visibility**
- При изменении видимости слоя, пересоздавать InstancedMesh эффективнее
- Добавить debounce для пересоздания (50ms)

---

## Структура изменений

### Новые файлы
- `components/Scene3D/OptimizedPanel.ts` — класс LOD панели
- `components/Scene3D/TextureManager.ts` — управление текстурами с кэшем
- `components/Scene3D/FrustumCuller.ts` — frustum culling утилита
- `components/Scene3D/Scene3D.tsx` — переработанный компонент (рефактор текущего файла)

### Изменённые файлы
- `components/Scene3D.tsx` — оптимизирован и разделён на модули

---

## Ожидаемые результаты

| Метрика | До | После | Улучшение |
|---------|-------|--------|-----------|
| FPS (на мобильных) | 30-40 | 50-60 | +50% |
| Память (GPU) | ~150MB | ~90MB | -40% |
| Время инициализации | ~800ms | ~400ms | -50% |
| Draw calls | 50-100 | 15-25 | -75% |

---

## Проверка

1. **Визуальная проверка**:
   - Запустить dev сервер
   - Загрузить проект с 50+ панелями
   - Проверить FPS в DevTools (должен быть стабилен > 50 FPS)
   - Протестировать LOD переходы (приближение/удаление)

2. **Performance profiling**:
   - Chrome DevTools → Performance tab
   - Захватить 10 секунд записи
   - Проверить:
     - Среднее FPS > 50
     - Draw calls < 30
     - GPU memory < 100MB

3. **Функциональная проверка**:
   - Выделение панелей работает корректно
   - Трансформация (translate/rotate) работает
   - Видимость слоёв обновляется корректно
   - Сетка и оси видны/скрываются правильно
   - ViewCube реагирует на камеру

---

## Замечания

- **Backward compatible**: все изменения скрыты внутри компонента, API остаётся прежним
- **Мобильная оптимизация**: уже учтена в проверках `isMobile`
- **InstancedMesh**: сохраняется как основной метод батчинга
- **Material caching**: расширяется с LOD поддержкой
